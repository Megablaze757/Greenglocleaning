// ===== Booking System =====
const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_7TZ_Y-HKZc_ibl59lqyAsQ_Qbv9A2o7';
const RESEND_API_KEY = 're_NiRLrvXk_4p6TfCmjQMXzVcGcnw99iDro';

let supabaseClient = null;
let currentBooking = {
    service: null,
    date: null,
    timeSlot: null,
    slotId: null,
    bedrooms: 1,
    calculatedPrice: 0,
    customer: {}
};

// Initialize Supabase
if (typeof supabase !== 'undefined') {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

// Test connection to bookings table
async function testBookingsTable() {
    if (!supabaseClient) {
        console.error('Supabase client not initialized');
        return false;
    }
    
    try {
        console.log('Testing bookings table connection...');
        
        // First, check if table exists by trying to select
        const { data, error } = await supabaseClient
            .from('bookings')
            .select('id')
            .limit(1);
        
        if (error) {
            console.error('Error accessing bookings table:', error);
            
            // Try to create the table if it doesn't exist
            if (error.message.includes('does not exist') || error.code === 'PGRST204') {
                console.log('Bookings table might not exist. Creating...');
                return await createBookingsTable();
            }
            return false;
        }
        
        console.log('Bookings table connection successful');
        return true;
        
    } catch (err) {
        console.error('Test connection failed:', err);
        return false;
    }
}

// Create bookings table if it doesn't exist
async function createBookingsTable() {
    try {
        // First check what tables exist
        const { data: tables, error: tablesError } = await supabaseClient
            .from('bookings')
            .select('*')
            .limit(0);
        
        if (tablesError) {
            console.log('Bookings table needs to be created');
            
            // You'll need to create the table in Supabase dashboard
            // Go to Table Editor > Create New Table
            console.error('Please create the bookings table in Supabase dashboard');
            console.error('Required columns: id, service_title, customer_name, customer_phone, customer_email, customer_address, booking_date, time_slot, price, status');
            return false;
        }
        
        return true;
    } catch (err) {
        console.error('Failed to check/table table:', err);
        return false;
    }
}

// Get table schema to understand what columns exist
async function getTableSchema() {
    if (!supabaseClient) return null;
    
    try {
        // Try to insert and see what happens
        const testData = {
            service_title: 'Test Service',
            customer_name: 'Test Customer',
            customer_phone: '1234567890',
            customer_email: 'test@example.com',
            customer_address: 'Test Address',
            booking_date: new Date().toISOString().split('T')[0],
            time_slot: '10:00-12:00',
            price: '¬£100',
            status: 'test'
        };
        
        const { data, error } = await supabaseClient
            .from('bookings')
            .insert([testData])
            .select();
        
        if (error) {
            console.error('Schema test error:', error);
            return { error: error.message, columns: null };
        }
        
        console.log('Schema test successful, table exists with these columns');
        return { success: true, columns: Object.keys(testData) };
        
    } catch (err) {
        console.error('Schema test failed:', err);
        return null;
    }
}

// Email Confirmation Function
async function sendConfirmationEmail(customerEmail, bookingDetails) {
    if (!customerEmail || !customerEmail.includes('@')) {
        return { success: false, reason: 'No valid email' };
    }
    
    const apiUrl = 'https://api.resend.com/emails';
    
    const emailData = {
        from: 'GreenGlo Cleaners <bookings@greenglocleaners.co.uk>',
        to: [customerEmail],
        reply_to: 'greenglocleaning@gmail.com',
        subject: `‚úÖ Booking Confirmed: ${bookingDetails.service} - ${bookingDetails.date}`,
        html: `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                    .header { background: linear-gradient(135deg, #10B981, #0D9488); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                    .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb; }
                    .booking-details { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #10B981; }
                    .footer { text-align: center; margin-top: 30px; color: #6b7280; font-size: 14px; }
                    h1, h2, h3 { color: #065F46; }
                    .highlight { background: #D1FAE5; padding: 15px; border-radius: 8px; margin: 15px 0; }
                    .btn { display: inline-block; background: #10B981; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; }
                    .price-badge { background: #FBBF24; color: #92400e; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 14px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1 style="color: white; margin: 0;">‚úÖ Booking Confirmed!</h1>
                    <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0;">Thank you for choosing GreenGlo Cleaners</p>
                </div>
                
                <div class="content">
                    <h2>üìã Your Booking Summary</h2>
                    <div class="booking-details">
                        <p><strong>Service:</strong> ${bookingDetails.service}</p>
                        <p><strong>Date:</strong> ${new Date(bookingDetails.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p><strong>Time:</strong> ${bookingDetails.timeSlot}</p>
                        <p><strong>Duration:</strong> ${bookingDetails.duration}</p>
                        <p><strong>Bedrooms:</strong> ${bookingDetails.bedrooms}</p>
                        <p><strong>Price:</strong> <span class="price-badge">${bookingDetails.price}</span></p>
                    </div>
                    
                    <div class="highlight">
                        <h3>üë§ Your Details</h3>
                        <p><strong>Name:</strong> ${bookingDetails.customerName}</p>
                        <p><strong>Phone:</strong> ${bookingDetails.customerPhone}</p>
                        <p><strong>Address:</strong> ${bookingDetails.customerAddress}</p>
                    </div>
                    
                    <h3>üìû What Happens Next?</h3>
                    <ul>
                        <li><strong>24-Hour Confirmation Call:</strong> Our team will call you within 24 hours to confirm all details</li>
                        <li><strong>Preparation:</strong> Please ensure access to the property during the booked time</li>
                        <li><strong>Our Team:</strong> Vetted, background-checked cleaners with eco-friendly products</li>
                        <li><strong>Payment:</strong> Payment is due upon completion of service (Cash, Card, or Bank Transfer)</li>
                    </ul>
                    
                    <h3>üîÑ Need to Make Changes?</h3>
                    <p>Contact us at <a href="tel:07827784204" style="color: #10B981; font-weight: bold;">07827 784204</a> or reply to this email</p>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <a href="tel:07827784204" class="btn">üìû Call Us Now</a>
                    </div>
                    
                    <div class="footer">
                        <p><strong>GreenGlo Cleaners London</strong><br>
                        üìû 07827 784204 | ‚úâÔ∏è greenglocleaning@gmail.com</p>
                        <p style="font-size: 12px; color: #9CA3AF; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            This is an automated confirmation email. Please do not reply directly to this email.<br>
                            Booking Reference: ${bookingDetails.bookingId || new Date().getTime()}
                        </p>
                    </div>
                </div>
            </body>
            </html>
        `,
        text: `
            ‚úÖ BOOKING CONFIRMED - GreenGlo Cleaners
            
            Your booking has been successfully confirmed!
            
            SERVICE DETAILS:
            =================
            Service: ${bookingDetails.service}
            Date: ${bookingDetails.date}
            Time: ${bookingDetails.timeSlot}
            Duration: ${bookingDetails.duration}
            Bedrooms: ${bookingDetails.bedrooms}
            Price: ${bookingDetails.price}
            
            CUSTOMER DETAILS:
            =================
            Name: ${bookingDetails.customerName}
            Phone: ${bookingDetails.customerPhone}
            Address: ${bookingDetails.customerAddress}
            
            NEXT STEPS:
            ===========
            1. We will call you within 24 hours to confirm all details
            2. Please ensure someone is available at the address
            3. Our cleaners will arrive with all necessary equipment
            4. Payment is due upon completion
            
            Need help? Call us at 07827 784204
            
            ---
            GreenGlo Cleaners London
            07827 784204 | greenglocleaning@gmail.com
            www.greenglocleaners.co.uk
        `
    };
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${RESEND_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            return { success: true, data };
        } else {
            return { success: false, error: data };
        }
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// Initialize Database Check
window.addEventListener('DOMContentLoaded', async function() {
    if (!supabaseClient) {
        console.error('Supabase client could not be initialized');
        return;
    }
    
    // Test the connection
    const tableExists = await testBookingsTable();
    
    if (!tableExists) {
        console.warn('Bookings table may not exist or have issues');
        // Show a subtle notification to admin
        if (window.location.href.includes('admin') || confirm('Would you like to test the database connection?')) {
            const schema = await getTableSchema();
            console.log('Table schema:', schema);
        }
    }
});

// ===== Booking Modal Functions =====
function openBookingModal(serviceTitle, serviceId, serviceData) {
    currentBooking.service = {
        title: serviceTitle,
        id: serviceId,
        data: serviceData
    };
    
    document.getElementById('bookingServiceName').textContent = serviceTitle;
    
    currentBooking.bedrooms = 1;
    currentBooking.calculatedPrice = 0;
    
    const bedroomGroup = document.getElementById('bedroomSelectionGroup');
    const priceDisplay = document.getElementById('priceDisplay');
    
    if (serviceData.hasBedrooms) {
        bedroomGroup.style.display = 'block';
        priceDisplay.style.display = 'block';
        renderBedroomOptions(serviceData);
    } else {
        bedroomGroup.style.display = 'none';
        priceDisplay.style.display = 'block';
        updatePriceDisplay(serviceData.basePrice);
    }
    
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('bookingDate');
    dateInput.min = today;
    dateInput.value = today;
    currentBooking.date = today;
    
    loadTimeSlots(today);
    
    document.getElementById('bookingModal').style.display = 'flex';
    document.getElementById('bookingStep1').style.display = 'block';
    document.getElementById('bookingStep2').style.display = 'none';
    
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
    document.getElementById('customerAddress').value = '';
    document.getElementById('bookingNotes').value = '';
}

function renderBedroomOptions(serviceData) {
    const container = document.getElementById('bedroomSelector');
    container.innerHTML = '';
    
    const bedroomOptions = [
        { value: 1, label: '1 Bed', icon: 'bed', price: serviceData.basePrice },
        { value: 2, label: '2 Bed', icon: 'bed', price: serviceData.basePrice + serviceData.perBedroomPrice },
        { value: 3, label: '3 Bed', icon: 'bed', price: serviceData.basePrice + (serviceData.perBedroomPrice * 2) },
        { value: 4, label: '4 Bed', icon: 'bed', price: serviceData.basePrice + (serviceData.perBedroomPrice * 3) },
        { value: 5, label: '5+ Bed', icon: 'bed', price: serviceData.basePrice + (serviceData.perBedroomPrice * 4) }
    ];
    
    bedroomOptions.forEach(option => {
        const optionElement = document.createElement('div');
        optionElement.className = 'bedroom-option';
        optionElement.dataset.bedrooms = option.value;
        optionElement.dataset.price = option.price;
        
        optionElement.innerHTML = `
            <div class="bedroom-icon">
                <i class="fas fa-${option.icon}"></i>
            </div>
            <div class="bedroom-label">${option.label}</div>
            <div class="bedroom-price">¬£${option.price}</div>
        `;
        
        optionElement.addEventListener('click', function() {
            document.querySelectorAll('.bedroom-option').forEach(o => {
                o.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            currentBooking.bedrooms = option.value;
            currentBooking.calculatedPrice = option.price;
            
            updatePriceDisplay(option.price);
        });
        
        container.appendChild(optionElement);
    });
    
    const firstOption = container.querySelector('.bedroom-option');
    if (firstOption) {
        firstOption.classList.add('selected');
        currentBooking.bedrooms = 1;
        currentBooking.calculatedPrice = bedroomOptions[0].price;
        updatePriceDisplay(bedroomOptions[0].price);
    }
}

function updatePriceDisplay(price) {
    document.getElementById('selectedPrice').textContent = `¬£${price}`;
    
    if (currentBooking.service.data.hasBedrooms) {
        const basePrice = currentBooking.service.data.basePrice;
        const perBedroom = currentBooking.service.data.perBedroomPrice;
        const breakdown = currentBooking.bedrooms > 1 
            ? `Base: ¬£${basePrice} + ¬£${perBedroom} √ó ${currentBooking.bedrooms - 1} bedroom(s)`
            : 'Standard 1 bedroom rate';
        
        document.getElementById('priceBreakdown').textContent = breakdown;
    } else {
        document.getElementById('priceBreakdown').textContent = 'Fixed price service';
    }
}

function closeBookingModal() {
    document.getElementById('bookingModal').style.display = 'none';
    currentBooking = {
        service: null,
        date: null,
        timeSlot: null,
        slotId: null,
        bedrooms: 1,
        calculatedPrice: 0,
        customer: {}
    };
}

document.getElementById('bookingModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBookingModal();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('bookingModal').style.display === 'flex') {
        closeBookingModal();
    }
});

document.getElementById('bookingDate').addEventListener('change', function() {
    currentBooking.date = this.value;
    loadTimeSlots(this.value);
});

async function loadTimeSlots(date) {
    const container = document.getElementById('timeSlotsContainer');
    container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 40px; color: var(--medium-gray);"><i class="fas fa-spinner fa-spin fa-2x"></i><div style="margin-top: 10px;">Loading available time slots...</div></div>';
    
    if (!supabaseClient) {
        container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 40px; color: var(--red);"><i class="fas fa-exclamation-triangle fa-2x"></i><div style="margin-top: 10px;">Error: Cannot connect to booking system</div></div>';
        return;
    }
    
    try {
        const { data: availability, error } = await supabaseClient
            .from('availability')
            .select('*')
            .eq('date', date)
            .eq('is_available', true)
            .order('time_slot');
        
        if (error) {
            throw error;
        }
        
        container.innerHTML = '';
        
        if (!availability || availability.length === 0) {
            container.innerHTML = `
                <div style="grid-column: span 2; text-align: center; padding: 40px; color: var(--medium-gray);">
                    <i class="fas fa-calendar-times fa-2x"></i>
                    <div style="margin-top: 15px; font-size: 18px; margin-bottom: 10px;">No Available Slots</div>
                    <div>No time slots available for ${new Date(date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    <div style="margin-top: 15px; font-size: 14px; color: var(--primary-green);">
                        <i class="fas fa-phone"></i> Call us at 07827 784204 for alternative times
                    </div>
                </div>
            `;
            return;
        }
        
        currentBooking.timeSlot = null;
        currentBooking.slotId = null;
        
        availability.forEach(slot => {
            const slotElement = document.createElement('div');
            slotElement.className = 'time-slot-option';
            slotElement.dataset.slotId = slot.id;
            slotElement.dataset.timeSlot = slot.time_slot;
            
            const [start, end] = slot.time_slot.split('-');
            
            slotElement.innerHTML = `
                <div style="font-weight: 700; color: var(--dark-green); margin-bottom: 5px; font-size: 18px;">
                    ${formatTime(start)}
                </div>
                <div style="font-size: 13px; color: var(--medium-gray); margin-bottom: 5px;">
                    to ${formatTime(end)}
                </div>
                <div style="font-size: 11px; color: var(--primary-green);">
                    <i class="fas fa-check-circle"></i> Available
                </div>
            `;
            
            slotElement.addEventListener('click', function() {
                document.querySelectorAll('.time-slot-option').forEach(s => {
                    s.classList.remove('selected');
                });
                
                this.classList.add('selected');
                
                currentBooking.timeSlot = slot.time_slot;
                currentBooking.slotId = String(slot.id);
            });
            
            container.appendChild(slotElement);
        });
        
    } catch (err) {
        container.innerHTML = `
            <div style="grid-column: span 2; text-align: center; padding: 40px; color: var(--red);">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <div style="margin-top: 15px; font-size: 18px; margin-bottom: 10px;">Connection Error</div>
                <div>Unable to load time slots. Please try again.</div>
                <button onclick="loadTimeSlots('${date}')" class="btn btn-outline" style="margin-top: 20px; padding: 10px 20px;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
    }
}

function formatTime(time) {
    const [hour, minute] = time.split(':');
    const hourNum = parseInt(hour);
    const suffix = hourNum >= 12 ? 'PM' : 'AM';
    const displayHour = hourNum > 12 ? hourNum - 12 : (hourNum === 0 ? 12 : hourNum);
    return `${displayHour}:${minute} ${suffix}`;
}

function nextBookingStep() {
    if (currentBooking.service.data.hasBedrooms && currentBooking.calculatedPrice <= 0) {
        alert('‚ö†Ô∏è Please select number of bedrooms');
        return;
    }
    
    if (!currentBooking.timeSlot) {
        alert('‚ö†Ô∏è Please select a time slot');
        return;
    }
    
    if (!currentBooking.slotId) {
        alert('‚ö†Ô∏è Error: No slot ID selected. Please select a time slot again.');
        return;
    }
    
    currentBooking.slotId = String(currentBooking.slotId);
    
    updateBookingSummary();
    
    document.getElementById('bookingStep1').style.display = 'none';
    document.getElementById('bookingStep2').style.display = 'block';
}

function prevBookingStep() {
    document.getElementById('bookingStep2').style.display = 'none';
    document.getElementById('bookingStep1').style.display = 'block';
}

function updateBookingSummary() {
    const summary = document.getElementById('summaryDetails');
    const [start, end] = currentBooking.timeSlot.split('-');
    const bookingDate = new Date(currentBooking.date);
    
    let priceDisplay = currentBooking.calculatedPrice 
        ? `¬£${currentBooking.calculatedPrice}`
        : currentBooking.service.data.displayPrice;
    
    let bedroomInfo = '';
    if (currentBooking.service.data.hasBedrooms) {
        bedroomInfo = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
                <span style="color: var(--dark-gray); font-weight: 600;">Bedrooms:</span>
                <span>${currentBooking.bedrooms} bedroom${currentBooking.bedrooms > 1 ? 's' : ''}</span>
            </div>
        `;
    }
    
    summary.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <span style="color: var(--dark-gray); font-weight: 600;">Service:</span>
            <span style="font-weight: 700; color: var(--dark-green);">${currentBooking.service.title}</span>
        </div>
        ${bedroomInfo}
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <span style="color: var(--dark-gray); font-weight: 600;">Price:</span>
            <span style="font-weight: 700; color: var(--primary-green); font-size: 1.25rem;">${priceDisplay}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <span style="color: var(--dark-gray); font-weight: 600;">Date:</span>
            <span>${bookingDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <span style="color: var(--dark-gray); font-weight: 600;">Time:</span>
            <span style="font-weight: 600; color: var(--primary-green);">${formatTime(start)} - ${formatTime(end)}</span>
        </div>
    `;
}

// UPDATED CONFIRM BOOKING FUNCTION WITH BETTER ERROR HANDLING
async function confirmBooking() {
    const customerName = document.getElementById('customerName').value.trim();
    const customerPhone = document.getElementById('customerPhone').value.trim();
    const customerAddress = document.getElementById('customerAddress').value.trim();
    const customerEmail = document.getElementById('customerEmail').value.trim();
    
    if (!customerName || !customerPhone || !customerAddress) {
        alert('‚ùå Please fill in all required fields:\n\n‚Ä¢ Full Name\n‚Ä¢ Phone Number\n‚Ä¢ Service Address');
        return;
    }
    
    if (!currentBooking.timeSlot || !currentBooking.slotId) {
        alert('‚ùå Please select a time slot');
        return;
    }
    
    if (!supabaseClient) {
        alert('‚ùå Cannot connect to booking system.\n\nPlease call us directly at 07827 784204.');
        return;
    }
    
    const confirmBtn = document.querySelector('.btn-success');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Booking...';
    confirmBtn.disabled = true;
    
    try {
        // Check if time slot is still available
        const { data: slotCheck, error: checkError } = await supabaseClient
            .from('availability')
            .select('*')
            .eq('id', currentBooking.slotId)
            .eq('is_available', true)
            .single();
        
        if (checkError || !slotCheck) {
            alert('‚ùå This time slot is no longer available.\n\nPlease select another time slot.');
            loadTimeSlots(currentBooking.date);
            return;
        }
        
        const serviceData = currentBooking.service.data;
        const serviceDuration = serviceData.duration;
        const bookingRef = 'GG' + Date.now().toString().slice(-8);
        const finalPrice = currentBooking.calculatedPrice || serviceData.basePrice;
        
        // Try multiple column name variations since we don't know the exact table structure
        const bookingDataAttempts = [
            // Attempt 1: Standard column names
            {
                service_title: currentBooking.service.title,
                service_id: parseInt(currentBooking.service.id),
                customer_name: customerName,
                customer_phone: customerPhone,
                customer_email: customerEmail || null,
                customer_address: customerAddress,
                booking_date: currentBooking.date,
                time_slot: currentBooking.timeSlot,
                duration: serviceDuration,
                bedrooms: currentBooking.service.data.hasBedrooms ? currentBooking.bedrooms : null,
                price: `¬£${finalPrice}`,
                calculated_price: finalPrice,
                notes: document.getElementById('bookingNotes').value.trim() || null,
                status: 'confirmed',
                booking_reference: bookingRef,
                created_at: new Date().toISOString()
            },
            // Attempt 2: Alternative column names
            {
                service: currentBooking.service.title,
                customer: customerName,
                phone: customerPhone,
                email: customerEmail || null,
                address: customerAddress,
                date: currentBooking.date,
                time: currentBooking.timeSlot,
                price: `¬£${finalPrice}`,
                status: 'confirmed'
            },
            // Attempt 3: Minimal data
            {
                service: currentBooking.service.title,
                name: customerName,
                phone: customerPhone,
                email: customerEmail,
                address: customerAddress,
                booking_date: currentBooking.date,
                time_slot: currentBooking.timeSlot,
                price: finalPrice
            }
        ];
        
        let insertSuccess = false;
        let lastError = null;
        
        // Try each attempt until one works
        for (let attempt of bookingDataAttempts) {
            try {
                console.log('Attempting to insert booking with data:', attempt);
                
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .insert([attempt])
                    .select();
                
                if (error) {
                    lastError = error;
                    console.warn('Insert attempt failed:', error.message);
                    continue; // Try next attempt
                }
                
                insertSuccess = true;
                console.log('Booking inserted successfully:', data);
                break; // Success, exit loop
                
            } catch (err) {
                lastError = err;
                console.warn('Insert attempt threw error:', err.message);
                continue;
            }
        }
        
        if (!insertSuccess) {
            throw new Error(`All insert attempts failed. Last error: ${lastError?.message || 'Unknown error'}`);
        }
        
        // Mark time slot as booked
        try {
            const { error: updateError } = await supabaseClient
                .from('availability')
                .update({ 
                    is_available: false,
                    updated_at: new Date().toISOString()
                })
                .eq('id', currentBooking.slotId);
            
            if (updateError) {
                console.warn('Failed to update availability:', updateError);
            }
        } catch (updateErr) {
            console.warn('Error updating availability:', updateErr);
        }
        
        // Prepare booking details for email
        const bookingDetails = {
            service: currentBooking.service.title,
            date: currentBooking.date,
            timeSlot: currentBooking.timeSlot,
            duration: serviceDuration,
            bedrooms: currentBooking.service.data.hasBedrooms ? currentBooking.bedrooms : 'N/A',
            price: `¬£${finalPrice}`,
            customerName: customerName,
            customerPhone: customerPhone,
            customerEmail: customerEmail,
            customerAddress: customerAddress,
            bookingId: bookingRef
        };
        
        // Send confirmation email if email is provided
        let emailSent = false;
        if (customerEmail && customerEmail.includes('@')) {
            try {
                const emailResult = await sendConfirmationEmail(customerEmail, bookingDetails);
                if (emailResult.success) {
                    emailSent = true;
                }
            } catch (emailError) {
                console.warn('Email sending error:', emailError);
            }
        }
        
        // Send WhatsApp notification to business
        const whatsappMessage = encodeURIComponent(
            `üìÖ NEW BOOKING CONFIRMED - GreenGlo Cleaners\n\n` +
            `üõ†Ô∏è Service: ${currentBooking.service.title}\n` +
            `üí∞ Price: ¬£${finalPrice}\n` +
            `üõèÔ∏è Bedrooms: ${currentBooking.service.data.hasBedrooms ? currentBooking.bedrooms : 'N/A'}\n` +
            `üìÖ Date: ${currentBooking.date}\n` +
            `üïí Time: ${currentBooking.timeSlot}\n` +
            `üìû Customer: ${customerName}\n` +
            `‚òéÔ∏è Phone: ${customerPhone}\n` +
            `üìß Email: ${customerEmail || 'Not provided'}\n` +
            `üè† Address: ${customerAddress}\n` +
            `üìù Notes: ${document.getElementById('bookingNotes').value.trim() || 'None'}\n` +
            `üîó Booking Ref: ${bookingRef}\n` +
            `üìß Email Status: ${emailSent ? '‚úÖ Sent' : '‚ùå Not sent'}\n\n` +
            `üí∞ Revenue: ¬£${finalPrice}`
        );
        
        const whatsappUrl = `https://api.whatsapp.com/send?phone=447827784204&text=${whatsappMessage}`;
        window.open(whatsappUrl, '_blank');
        
        // Show success message
        const bookingDate = new Date(currentBooking.date);
        const formattedDate = bookingDate.toLocaleDateString('en-GB', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        const successMessage = `
‚úÖ BOOKING CONFIRMED!

üìã SERVICE DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Service: ${currentBooking.service.title}
${currentBooking.service.data.hasBedrooms ? `Bedrooms: ${currentBooking.bedrooms}\n` : ''}
Price: ¬£${finalPrice}
Date: ${formattedDate}
Time: ${currentBooking.timeSlot}
Booking Ref: ${bookingRef}

üë§ CUSTOMER DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Name: ${customerName}
Phone: ${customerPhone}
${customerEmail ? `Email: ${customerEmail}\n` : ''}
Address: ${customerAddress}

üìß CONFIRMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${emailSent ? 'A confirmation email has been sent to your email address.\n' : customerEmail ? '‚ö†Ô∏è Email confirmation failed. Please save this booking reference.\n' : ''}

üìû NEXT STEPS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
We will call you within 24 hours to confirm all details.

Thank you for choosing GreenGlo Cleaners! üåø
        `;
        
        alert(successMessage);
        
        // Close modal after delay
        setTimeout(() => {
            closeBookingModal();
        }, 1000);
        
    } catch (err) {
        console.error('Booking error details:', err);
        
        let errorMessage = '‚ùå BOOKING FAILED\n\n';
        
        if (err.message.includes('customer_email') || err.message.includes('service_title')) {
            errorMessage += 'Database table structure issue.\n\n';
            errorMessage += 'Please check your Supabase "bookings" table columns.\n\n';
            errorMessage += 'Required columns: service_title, customer_name, customer_phone, customer_email, customer_address, booking_date, time_slot, price\n\n';
            errorMessage += 'Check console (F12) for more details.';
        } else if (err.message.includes('network') || err.message.includes('fetch')) {
            errorMessage += 'Network connection error.\n\nPlease check your internet connection.';
        } else if (err.message.includes('permission') || err.message.includes('auth')) {
            errorMessage += 'Database permission error.\n\n';
        } else if (err.message.includes('duplicate')) {
            errorMessage += 'Time slot already booked.\n\nPlease select another time.';
        } else {
            errorMessage += `Technical error: ${err.message}\n\n`;
        }
        
        errorMessage += '\nüìû PLEASE CALL US DIRECTLY AT:\n07827 784204\n\nWe can take your booking over the phone.';
        
        alert(errorMessage);
        
    } finally {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

document.getElementById('closeBookingModal').addEventListener('click', closeBookingModal);

// Add test function to check database
function testDatabaseConnection() {
    if (!supabaseClient) {
        alert('Supabase client not initialized');
        return;
    }
    
    const testBtn = document.createElement('button');
    testBtn.textContent = 'Test Database';
    testBtn.className = 'btn';
    testBtn.style.position = 'fixed';
    testBtn.style.bottom = '150px';
    testBtn.style.right = '30px';
    testBtn.style.zIndex = '9999';
    testBtn.style.background = 'var(--gradient-gold)';
    testBtn.onclick = async function() {
        const result = await testBookingsTable();
        if (result) {
            alert('‚úÖ Database connection successful!\n\nBookings should save to the "bookings" table.');
        } else {
            alert('‚ùå Database connection failed.\n\nPlease check:\n1. Supabase project is active\n2. "bookings" table exists\n3. RLS policies allow inserts\n4. Check browser console (F12) for details');
        }
    };
    document.body.appendChild(testBtn);
}

// Initialize test button on page load
window.addEventListener('DOMContentLoaded', function() {
    // Only show test button if URL has debug parameter
    if (window.location.href.includes('debug') || window.location.href.includes('test')) {
        setTimeout(testDatabaseConnection, 2000);
    }
});
