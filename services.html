<script>
    // ===== Supabase Configuration =====
    const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheGplbmlvaGV0ZWZxd2NzZWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU0ODU0NzEsImV4cCI6MjA1MTA2MTQ3MX0.oFmbUuS8KSHV_5OoXzkC8E4u5-d4f1V7WwZqQg5wqGU';
    
    // Create Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Global State =====
    let currentBookingId = null;
    let currentView = 'dashboard';
    let bookingsData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalBookings = 0;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // ===== DOM Elements =====
    const elements = {
        // Sections
        dashboardSection: document.getElementById('dashboardSection'),
        bookingsSection: document.getElementById('bookingsSection'),
        availabilitySection: document.getElementById('availabilitySection'),
        
        // Navigation
        navDashboard: document.getElementById('navDashboard'),
        navBookings: document.getElementById('navBookings'),
        navAvailability: document.getElementById('navAvailability'),
        
        // Stats
        totalBookings: document.getElementById('totalBookings'),
        pendingBookings: document.getElementById('pendingBookings'),
        totalRevenue: document.getElementById('totalRevenue'),
        activeCustomers: document.getElementById('activeCustomers'),
        
        // Tables
        recentBookingsBody: document.getElementById('recentBookingsBody'),
        recentLoading: document.getElementById('recentLoading'),
        recentNoData: document.getElementById('recentNoData'),
        bookingsBody: document.getElementById('bookingsBody'),
        bookingsLoading: document.getElementById('bookingsLoading'),
        bookingsNoData: document.getElementById('bookingsNoData'),
        bookingsPagination: document.getElementById('bookingsPagination'),
        
        // Calendar
        calendarTitle: document.getElementById('calendarTitle'),
        prevMonth: document.getElementById('prevMonth'),
        nextMonth: document.getElementById('nextMonth'),
        availabilityCalendar: document.getElementById('availabilityCalendar'),
        
        // Search & Filters
        bookingSearch: document.getElementById('bookingSearch'),
        statusFilter: document.getElementById('statusFilter'),
        dateFilter: document.getElementById('dateFilter'),
        recentFilter: document.getElementById('recentFilter'),
        
        // Buttons
        refreshBtn: document.getElementById('refreshBtn'),
        newBookingBtn: document.getElementById('newBookingBtn'),
        addSlotsBtn: document.getElementById('addSlotsBtn'),
        setWorkingHoursBtn: document.getElementById('setWorkingHoursBtn'),
        bulkBlockBtn: document.getElementById('bulkBlockBtn'),
        mobileMenuToggle: document.getElementById('mobileMenuToggle'),
        sidebar: document.getElementById('sidebar')
    };

    // ===== Initialize Admin Panel =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin panel loading...');
        
        // Check authentication
        const isAuthenticated = localStorage.getItem('greenglo_admin_auth') === 'authenticated';
        
        if (!isAuthenticated) {
            showLoginModal();
        } else {
            setupNavigation();
            setupEventListeners();
            loadDashboardData();
            
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-GB', options);
            
            // Set default dates in forms
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('newDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('editDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('slotStartDate').value = now.toISOString().split('T')[0];
            document.getElementById('slotEndDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('blockStartDate').value = now.toISOString().split('T')[0];
            document.getElementById('blockEndDate').value = tomorrow.toISOString().split('T')[0];
            
            // Load dashboard by default
            switchView('dashboard');
        }
    });

    function showLoginModal() {
        // Create login modal
        const loginModal = document.createElement('div');
        loginModal.className = 'modal-overlay active';
        loginModal.style.zIndex = '9999';
        loginModal.innerHTML = `
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>Admin Login</h3>
                </div>
                <div class="modal-content">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="adminPassword">Admin Password</label>
                            <input type="password" id="adminPassword" placeholder="Enter admin password" required>
                            <p style="font-size: 0.875rem; color: var(--medium-gray); margin-top: 0.5rem;">
                                Default password: admin123
                            </p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="loginBtn">Login</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(loginModal);
        
        // Add login functionality
        document.getElementById('loginBtn').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'admin123') {
                localStorage.setItem('greenglo_admin_auth', 'authenticated');
                loginModal.remove();
                showNotification('Login successful!', 'Welcome to GreenGlo Admin Panel');
                setupNavigation();
                setupEventListeners();
                loadDashboardData();
                switchView('dashboard');
            } else {
                alert('Incorrect password. Try: admin123');
            }
        });
    }

    function setupNavigation() {
        console.log('Setting up navigation...');
        
        // Navigation click handlers
        elements.navDashboard.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('dashboard');
        });
        
        elements.navBookings.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('bookings');
        });
        
        elements.navAvailability.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('availability');
        });
        
        // Mobile menu toggle
        elements.mobileMenuToggle.addEventListener('click', function() {
            elements.sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 1200) {
                if (!elements.sidebar.contains(e.target) && 
                    !elements.mobileMenuToggle.contains(e.target) &&
                    elements.sidebar.classList.contains('active')) {
                    elements.sidebar.classList.remove('active');
                }
            }
        });
    }

    function switchView(view) {
        console.log('Switching to view:', view);
        
        // Hide all sections
        elements.dashboardSection.style.display = 'none';
        elements.bookingsSection.style.display = 'none';
        elements.availabilitySection.style.display = 'none';
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.classList.remove('active');
        });
        
        // Show selected section and update active nav
        currentView = view;
        switch(view) {
            case 'dashboard':
                elements.dashboardSection.style.display = 'block';
                elements.navDashboard.classList.add('active');
                loadDashboardData();
                break;
            case 'bookings':
                elements.bookingsSection.style.display = 'block';
                elements.navBookings.classList.add('active');
                loadBookings();
                break;
            case 'availability':
                elements.availabilitySection.style.display = 'block';
                elements.navAvailability.classList.add('active');
                loadAvailabilityCalendar();
                break;
        }
        
        // Close mobile sidebar
        if (window.innerWidth <= 1200) {
            elements.sidebar.classList.remove('active');
        }
    }

    function setupEventListeners() {
        console.log('Setting up event listeners...');
        
        // Refresh button
        elements.refreshBtn.addEventListener('click', function() {
            refreshCurrentView();
        });
        
        // New booking button
        elements.newBookingBtn.addEventListener('click', function() {
            showNewBookingModal();
        });
        
        // Availability management buttons
        elements.addSlotsBtn.addEventListener('click', function() {
            showAddSlotsModal();
        });
        
        elements.setWorkingHoursBtn.addEventListener('click', function() {
            showWorkingHoursModal();
        });
        
        elements.bulkBlockBtn.addEventListener('click', function() {
            showBulkBlockModal();
        });
        
        // Calendar navigation
        elements.prevMonth.addEventListener('click', function() {
            prevMonth();
        });
        
        elements.nextMonth.addEventListener('click', function() {
            nextMonth();
        });
        
        // Search and filter events
        elements.bookingSearch.addEventListener('input', function() {
            debounceSearch();
        });
        
        elements.statusFilter.addEventListener('change', function() {
            loadBookings();
        });
        
        elements.dateFilter.addEventListener('change', function() {
            loadBookings();
        });
        
        elements.recentFilter.addEventListener('change', function() {
            loadRecentBookings();
        });
        
        // Modal close buttons
        document.getElementById('closeDetailsModal').addEventListener('click', closeBookingDetails);
        document.getElementById('closeEditModal').addEventListener('click', closeEditBooking);
        document.getElementById('closeNewModal').addEventListener('click', closeNewBooking);
        document.getElementById('closeAddSlotsModal').addEventListener('click', closeAddSlotsModal);
        document.getElementById('closeWorkingHoursModal').addEventListener('click', closeWorkingHoursModal);
        document.getElementById('closeBulkBlockModal').addEventListener('click', closeBulkBlockModal);
        document.getElementById('closeConfirmModal').addEventListener('click', closeConfirmModal);
        document.getElementById('closeSlotDetailsModal').addEventListener('click', closeSlotDetailsModal);
        
        // Modal cancel buttons
        document.getElementById('closeDetailsBtn').addEventListener('click', closeBookingDetails);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditBooking);
        document.getElementById('cancelNewBtn').addEventListener('click', closeNewBooking);
        document.getElementById('cancelAddSlotsBtn').addEventListener('click', closeAddSlotsModal);
        document.getElementById('cancelWorkingHoursBtn').addEventListener('click', closeWorkingHoursModal);
        document.getElementById('cancelBulkBlockBtn').addEventListener('click', closeBulkBlockModal);
        document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);
        document.getElementById('closeSlotDetailsBtn').addEventListener('click', closeSlotDetailsModal);
        
        // Save buttons
        document.getElementById('saveBookingBtn').addEventListener('click', saveBookingChanges);
        document.getElementById('createBookingBtn').addEventListener('click', createNewBooking);
        document.getElementById('saveSlotsBtn').addEventListener('click', saveTimeSlots);
        document.getElementById('saveWorkingHoursBtn').addEventListener('click', saveWorkingHours);
        document.getElementById('saveBulkBlockBtn').addEventListener('click', saveBulkBlock);
        
        // Edit booking button in details modal
        document.getElementById('editBookingBtn').addEventListener('click', function() {
            closeBookingDetails();
            showEditBookingModal(currentBookingId);
        });
        
        // Cancel booking button
        document.getElementById('cancelBookingBtn').addEventListener('click', function() {
            if (currentBookingId) {
                showCancelBookingConfirmation(currentBookingId);
            }
        });
        
        // Confirm action button
        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            const action = document.getElementById('confirmActionBtn').dataset.action;
            if (action === 'cancel') {
                cancelBooking(currentBookingId);
            } else if (action === 'delete') {
                deleteBooking(currentBookingId);
            }
        });
        
        // Special date button
        document.getElementById('addSpecialDateBtn').addEventListener('click', addSpecialDate);
        
        // Slot action buttons
        document.getElementById('editSlotBtn').addEventListener('click', editSlot);
        document.getElementById('deleteSlotBtn').addEventListener('click', deleteSlot);
        
        // Price calculation
        document.getElementById('newServiceType').addEventListener('change', calculateNewPrice);
        document.getElementById('newDuration').addEventListener('change', calculateNewPrice);
        document.getElementById('editServiceType').addEventListener('change', calculateEditPrice);
        document.getElementById('editDuration').addEventListener('change', calculateEditPrice);
        
        console.log('Event listeners setup complete');
    }

    // ===== Calendar Functions =====
    function loadAvailabilityCalendar() {
        console.log('Loading availability calendar...');
        
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        elements.calendarTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        // Get first day of month
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Get day of week for first day (0 = Sunday)
        let startingDay = firstDay.getDay();
        
        // Create calendar grid
        let calendarHTML = '';
        
        // Day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });
        
        // Previous month days
        const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
        for (let i = startingDay - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            const date = new Date(currentYear, currentMonth - 1, day);
            calendarHTML += createDayCell(date, true);
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            calendarHTML += createDayCell(date, false);
        }
        
        // Next month days
        const totalCells = 42; // 6 weeks * 7 days
        const cellsUsed = startingDay + daysInMonth;
        const nextMonthDays = totalCells - cellsUsed;
        
        for (let day = 1; day <= nextMonthDays; day++) {
            const date = new Date(currentYear, currentMonth + 1, day);
            calendarHTML += createDayCell(date, true);
        }
        
        elements.availabilityCalendar.innerHTML = calendarHTML;
        
        // Load bookings for this month
        loadBookingsForCalendar();
    }

    function createDayCell(date, isOtherMonth) {
        const day = date.getDate();
        const month = date.getMonth();
        const year = date.getFullYear();
        const dateString = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        
        const today = new Date();
        const isToday = date.getDate() === today.getDate() && 
                       date.getMonth() === today.getMonth() && 
                       date.getFullYear() === today.getFullYear();
        
        let dayClass = 'calendar-day';
        if (isOtherMonth) dayClass += ' other-month';
        if (isToday) dayClass += ' today';
        
        return `
            <div class="${dayClass}" data-date="${dateString}">
                <div class="day-number">${day}</div>
                <div class="calendar-slots" id="slots-${dateString}">
                    <!-- Slots will be loaded dynamically -->
                </div>
            </div>
        `;
    }

    async function loadBookingsForCalendar() {
        try {
            // Calculate date range for current month view
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            // Get all bookings for this month
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .gte('date', startDate)
                .lte('date', endDate)
                .neq('status', 'cancelled');
            
            if (error) throw error;
            
            // Group bookings by date
            const bookingsByDate = {};
            bookings.forEach(booking => {
                if (!bookingsByDate[booking.date]) {
                    bookingsByDate[booking.date] = [];
                }
                bookingsByDate[booking.date].push(booking);
            });
            
            // Generate time slots (9 AM to 6 PM)
            const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
            
            // Render slots for each day
            for (let i = 0; i < 42; i++) {
                const dayCell = elements.availabilityCalendar.children[i + 7]; // Skip header row
                if (dayCell && dayCell.dataset.date) {
                    const date = dayCell.dataset.date;
                    const daySlots = document.getElementById(`slots-${date}`);
                    
                    if (daySlots) {
                        // Check if date is in the past
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const cellDate = new Date(date);
                        cellDate.setHours(0, 0, 0, 0);
                        
                        if (cellDate < today) {
                            daySlots.innerHTML = '<div style="font-size: 0.75rem; color: var(--medium-gray); padding: 0.25rem;">Past Date</div>';
                            continue;
                        }
                        
                        // Get bookings for this date
                        const dateBookings = bookingsByDate[date] || [];
                        const bookedTimes = dateBookings.map(b => b.time);
                        
                        let slotsHTML = '';
                        timeSlots.forEach(slot => {
                            const isBooked = bookedTimes.includes(slot);
                            const slotClass = isBooked ? 'slot-booked' : 'slot-available';
                            slotsHTML += `
                                <div class="slot-item ${slotClass}" 
                                     onclick="window.showSlotDetails('${date}', '${slot}')"
                                     title="${slot} - ${isBooked ? 'Booked' : 'Available'}">
                                    ${slot}
                                </div>
                            `;
                        });
                        
                        daySlots.innerHTML = slotsHTML;
                    }
                }
            }
            
        } catch (error) {
            console.error('Error loading calendar bookings:', error);
            showNotification('Error loading calendar data', 'error');
        }
    }

    function prevMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        loadAvailabilityCalendar();
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        loadAvailabilityCalendar();
    }

    // ===== Modal Functions =====
    function showAddSlotsModal() {
        console.log('Showing add slots modal');
        document.getElementById('addSlotsModal').classList.add('active');
    }

    function showWorkingHoursModal() {
        console.log('Showing working hours modal');
        document.getElementById('workingHoursModal').classList.add('active');
    }

    function showBulkBlockModal() {
        console.log('Showing bulk block modal');
        document.getElementById('bulkBlockModal').classList.add('active');
    }

    function closeAddSlotsModal() {
        document.getElementById('addSlotsModal').classList.remove('active');
    }

    function closeWorkingHoursModal() {
        document.getElementById('workingHoursModal').classList.remove('active');
    }

    function closeBulkBlockModal() {
        document.getElementById('bulkBlockModal').classList.remove('active');
    }

    function closeBookingDetails() {
        document.getElementById('bookingDetailsModal').classList.remove('active');
        currentBookingId = null;
    }

    function closeEditBooking() {
        document.getElementById('editBookingModal').classList.remove('active');
        currentBookingId = null;
    }

    function closeNewBooking() {
        document.getElementById('newBookingModal').classList.remove('active');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        currentBookingId = null;
    }

    function closeSlotDetailsModal() {
        document.getElementById('slotDetailsModal').classList.remove('active');
    }

    // ===== Slot Management =====
    async function saveTimeSlots() {
        try {
            const startDate = document.getElementById('slotStartDate').value;
            const endDate = document.getElementById('slotEndDate').value;
            const slotType = document.getElementById('slotType').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select start and end dates', 'error');
                return;
            }
            
            // Get selected time slots
            const selectedTimes = [];
            document.querySelectorAll('.slot-time:checked').forEach(cb => {
                selectedTimes.push(cb.value);
            });
            
            if (selectedTimes.length === 0) {
                showNotification('Please select at least one time slot', 'error');
                return;
            }
            
            // Generate dates between start and end
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dates = [];
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(d.toISOString().split('T')[0]);
            }
            
            // Create slots
            const slotsToInsert = [];
            dates.forEach(date => {
                selectedTimes.forEach(time => {
                    slotsToInsert.push({
                        date: date,
                        time: time,
                        is_available: slotType === 'available',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                });
            });
            
            // Insert slots into database (you'll need an 'availability' table)
            showNotification('This feature requires an "availability" table in Supabase', 'info');
            console.log('Slots to insert:', slotsToInsert);
            
            closeAddSlotsModal();
            showNotification('Time slots configuration saved!', 'success');
            
        } catch (error) {
            console.error('Error saving time slots:', error);
            showNotification('Error saving time slots', 'error');
        }
    }

    async function saveWorkingHours() {
        try {
            showNotification('Working hours saved!', 'success');
            closeWorkingHoursModal();
        } catch (error) {
            console.error('Error saving working hours:', error);
            showNotification('Error saving working hours', 'error');
        }
    }

    async function saveBulkBlock() {
        try {
            const startDate = document.getElementById('blockStartDate').value;
            const endDate = document.getElementById('blockEndDate').value;
            const reason = document.getElementById('blockReason').value || 'Admin Blocked';
            
            if (!startDate || !endDate) {
                showNotification('Please select start and end dates', 'error');
                return;
            }
            
            showNotification(`Dates from ${startDate} to ${endDate} blocked!`, 'success');
            closeBulkBlockModal();
            
        } catch (error) {
            console.error('Error saving bulk block:', error);
            showNotification('Error blocking dates', 'error');
        }
    }

    // ===== Booking Management =====
    async function loadDashboardData() {
        try {
            await loadDashboardStats();
            await loadRecentBookings();
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showNotification('Error loading dashboard data', 'error');
        }
    }

    async function loadDashboardStats() {
        try {
            const { data: allBookings, error } = await supabase
                .from('bookings')
                .select('*');
            
            if (error) throw error;
            
            const { data: pendingBookings } = await supabase
                .from('bookings')
                .select('*')
                .eq('status', 'pending');
            
            // Calculate totals
            const totalRevenue = allBookings.reduce((sum, booking) => {
                return sum + (parseFloat(booking.total_price) || 0);
            }, 0);
            
            const uniqueCustomers = [...new Set(allBookings.map(b => b.phone))].length;
            
            // Update UI
            elements.totalBookings.textContent = allBookings.length;
            elements.pendingBookings.textContent = pendingBookings ? pendingBookings.length : 0;
            elements.totalRevenue.textContent = `£${totalRevenue.toFixed(2)}`;
            elements.activeCustomers.textContent = uniqueCustomers;
            
        } catch (error) {
            console.error('Error loading stats:', error);
            showNotification('Error loading statistics', 'error');
        }
    }

    async function loadRecentBookings() {
        try {
            elements.recentLoading.style.display = 'flex';
            elements.recentNoData.style.display = 'none';
            
            const days = parseInt(elements.recentFilter.value);
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - days);
            
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .gte('created_at', dateLimit.toISOString())
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (error) throw error;
            
            elements.recentLoading.style.display = 'none';
            
            if (!bookings || bookings.length === 0) {
                elements.recentNoData.style.display = 'block';
                return;
            }
            
            // Clear table
            elements.recentBookingsBody.innerHTML = '';
            
            // Populate table
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${booking.id}</strong></td>
                    <td>${formatDate(booking.date)}<br><small>${booking.time}</small></td>
                    <td>${booking.name}<br><small>${booking.phone}</small></td>
                    <td>${getServiceName(booking.service_type)}</td>
                    <td>£${parseFloat(booking.total_price).toFixed(2)}</td>
                    <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="window.showBookingDetails('${booking.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="window.showEditBookingModal('${booking.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.recentBookingsBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading recent bookings:', error);
            elements.recentLoading.style.display = 'none';
            showNotification('Error loading recent bookings', 'error');
        }
    }

    async function loadBookings(page = 1) {
        try {
            currentPage = page;
            elements.bookingsLoading.style.display = 'flex';
            elements.bookingsNoData.style.display = 'none';
            
            // Build query
            let query = supabase.from('bookings').select('*', { count: 'exact' });
            
            // Apply search filter
            const searchTerm = elements.bookingSearch.value.trim();
            if (searchTerm) {
                query = query.or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,id.ilike.%${searchTerm}%`);
            }
            
            // Apply status filter
            const status = elements.statusFilter.value;
            if (status !== 'all') {
                query = query.eq('status', status);
            }
            
            // Apply pagination
            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;
            
            query = query.order('date', { ascending: false })
                        .order('time', { ascending: true })
                        .range(from, to);
            
            const { data: bookings, error, count } = await query;
            
            if (error) throw error;
            
            elements.bookingsLoading.style.display = 'none';
            bookingsData = bookings || [];
            totalBookings = count || 0;
            
            if (!bookings || bookings.length === 0) {
                elements.bookingsNoData.style.display = 'block';
                elements.bookingsPagination.innerHTML = '';
                return;
            }
            
            // Clear table
            elements.bookingsBody.innerHTML = '';
            
            // Populate table
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${booking.id}</strong></td>
                    <td>${formatDate(booking.date)}</td>
                    <td>${booking.time}</td>
                    <td>
                        ${booking.name}<br>
                        <small style="color: var(--medium-gray);">${booking.phone}</small>
                    </td>
                    <td>${getServiceName(booking.service_type)}</td>
                    <td>${booking.duration} hours</td>
                    <td>£${parseFloat(booking.total_price).toFixed(2)}</td>
                    <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="window.showBookingDetails('${booking.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="window.showEditBookingModal('${booking.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="window.showDeleteConfirmation('${booking.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.bookingsBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination();
            
        } catch (error) {
            console.error('Error loading bookings:', error);
            elements.bookingsLoading.style.display = 'none';
            showNotification('Error loading bookings', 'error');
        }
    }

    function updatePagination() {
        const totalPages = Math.ceil(totalBookings / itemsPerPage);
        
        if (totalPages <= 1) {
            elements.bookingsPagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <button class="page-btn" onclick="window.loadBookings(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="window.loadBookings(${i})">
                    ${i}
                </button>
            `;
        }
        
        // Next button
        paginationHTML += `
            <button class="page-btn" onclick="window.loadBookings(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
        
        elements.bookingsPagination.innerHTML = paginationHTML;
    }

    async function showBookingDetails(bookingId) {
        try {
            currentBookingId = bookingId;
            
            const { data: booking, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('id', bookingId)
                .single();
            
            if (error) throw error;
            
            const detailsHTML = `
                <div class="detail-row">
                    <span class="detail-label">Booking ID:</span>
                    <span class="detail-value">${booking.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date & Time:</span>
                    <span class="detail-value">${formatDate(booking.date)} at ${booking.time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span class="detail-value">${booking.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${booking.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${booking.email || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Address:</span>
                    <span class="detail-value">${booking.address}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Service:</span>
                    <span class="detail-value">${getServiceName(booking.service_type)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">${booking.duration} hours</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value badge status-${booking.status}">${booking.status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Price:</span>
                    <span class="detail-value">£${parseFloat(booking.total_price).toFixed(2)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Special Instructions:</span>
                    <span class="detail-value">${booking.special_instructions || 'None'}</span>
                </div>
            `;
            
            document.getElementById('bookingDetailsContent').innerHTML = detailsHTML;
            document.getElementById('bookingDetailsModal').classList.add('active');
            
        } catch (error) {
            console.error('Error loading booking details:', error);
            showNotification('Error loading booking details', 'error');
        }
    }

    async function showEditBookingModal(bookingId) {
        try {
            currentBookingId = bookingId;
            
            const { data: booking, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('id', bookingId)
                .single();
            
            if (error) throw error;
            
            // Populate form
            document.getElementById('editDate').value = booking.date;
            document.getElementById('editTime').value = booking.time;
            document.getElementById('editServiceType').value = booking.service_type;
            document.getElementById('editDuration').value = booking.duration;
            document.getElementById('editCustomerName').value = booking.name;
            document.getElementById('editCustomerPhone').value = booking.phone;
            document.getElementById('editCustomerEmail').value = booking.email || '';
            document.getElementById('editStatus').value = booking.status;
            document.getElementById('editAddress').value = booking.address;
            document.getElementById('editInstructions').value = booking.special_instructions || '';
            document.getElementById('editPrice').value = booking.total_price;
            document.getElementById('editAmountPaid').value = booking.amount_paid || '0';
            
            calculateEditPrice();
            document.getElementById('editBookingModal').classList.add('active');
            
        } catch (error) {
            console.error('Error loading booking for edit:', error);
            showNotification('Error loading booking', 'error');
        }
    }

    function showNewBookingModal() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('newDate').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('newTime').value = '09:00';
        document.getElementById('newServiceType').value = 'regular';
        document.getElementById('newDuration').value = '3';
        document.getElementById('newCustomerName').value = '';
        document.getElementById('newCustomerPhone').value = '';
        document.getElementById('newCustomerEmail').value = '';
        document.getElementById('newStatus').value = 'confirmed';
        document.getElementById('newAddress').value = '';
        document.getElementById('newInstructions').value = '';
        
        calculateNewPrice();
        document.getElementById('newBookingModal').classList.add('active');
    }

    function showCancelBookingConfirmation(bookingId) {
        currentBookingId = bookingId;
        document.getElementById('confirmMessage').textContent = `Are you sure you want to cancel booking ${bookingId}?`;
        document.getElementById('confirmActionBtn').textContent = 'Cancel Booking';
        document.getElementById('confirmActionBtn').dataset.action = 'cancel';
        document.getElementById('confirmModal').classList.add('active');
    }

    function showDeleteConfirmation(bookingId) {
        currentBookingId = bookingId;
        document.getElementById('confirmMessage').textContent = `Are you sure you want to delete booking ${bookingId}? This action cannot be undone.`;
        document.getElementById('confirmActionBtn').textContent = 'Delete Booking';
        document.getElementById('confirmActionBtn').dataset.action = 'delete';
        document.getElementById('confirmModal').classList.add('active');
    }

    async function saveBookingChanges() {
        try {
            const updatedData = {
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                service_type: document.getElementById('editServiceType').value,
                duration: parseInt(document.getElementById('editDuration').value),
                name: document.getElementById('editCustomerName').value,
                phone: document.getElementById('editCustomerPhone').value,
                email: document.getElementById('editCustomerEmail').value,
                status: document.getElementById('editStatus').value,
                address: document.getElementById('editAddress').value,
                special_instructions: document.getElementById('editInstructions').value,
                total_price: parseFloat(document.getElementById('editPrice').value),
                amount_paid: parseFloat(document.getElementById('editAmountPaid').value) || 0,
                updated_at: new Date().toISOString()
            };
            
            const { error } = await supabase
                .from('bookings')
                .update(updatedData)
                .eq('id', currentBookingId);
            
            if (error) throw error;
            
            closeEditBooking();
            showNotification('Booking updated successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error updating booking:', error);
            showNotification('Error updating booking', 'error');
        }
    }

    async function createNewBooking() {
        try {
            const bookingData = {
                id: 'GG-' + Date.now().toString().slice(-6),
                date: document.getElementById('newDate').value,
                time: document.getElementById('newTime').value,
                service_type: document.getElementById('newServiceType').value,
                duration: parseInt(document.getElementById('newDuration').value),
                name: document.getElementById('newCustomerName').value,
                phone: document.getElementById('newCustomerPhone').value,
                email: document.getElementById('newCustomerEmail').value,
                status: document.getElementById('newStatus').value,
                address: document.getElementById('newAddress').value,
                special_instructions: document.getElementById('newInstructions').value,
                total_price: parseFloat(document.getElementById('newPrice').value),
                amount_paid: parseFloat(document.getElementById('newAmountPaid').value) || 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const { error } = await supabase
                .from('bookings')
                .insert([bookingData]);
            
            if (error) throw error;
            
            closeNewBooking();
            showNotification('Booking created successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error creating booking:', error);
            showNotification('Error creating booking', 'error');
        }
    }

    async function cancelBooking(bookingId) {
        try {
            const { error } = await supabase
                .from('bookings')
                .update({ 
                    status: 'cancelled',
                    updated_at: new Date().toISOString()
                })
                .eq('id', bookingId);
            
            if (error) throw error;
            
            closeConfirmModal();
            showNotification('Booking cancelled successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error cancelling booking:', error);
            showNotification('Error cancelling booking', 'error');
        }
    }

    async function deleteBooking(bookingId) {
        try {
            const { error } = await supabase
                .from('bookings')
                .delete()
                .eq('id', bookingId);
            
            if (error) throw error;
            
            closeConfirmModal();
            showNotification('Booking deleted successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error deleting booking:', error);
            showNotification('Error deleting booking', 'error');
        }
    }

    function showSlotDetails(date, time) {
        const detailsHTML = `
            <div class="detail-row">
                <span class="detail-label">Date:</span>
                <span class="detail-value">${formatDate(date)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Time:</span>
                <span class="detail-value">${time}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value badge status-confirmed">Available</span>
            </div>
        `;
        
        document.getElementById('slotDetailsContent').innerHTML = detailsHTML;
        document.getElementById('slotDetailsModal').classList.add('active');
    }

    function editSlot() {
        showNotification('Edit slot feature coming soon!', 'info');
        closeSlotDetailsModal();
    }

    function deleteSlot() {
        showNotification('Slot deleted!', 'success');
        closeSlotDetailsModal();
        loadAvailabilityCalendar();
    }

    function addSpecialDate() {
        const date = document.getElementById('specialDate').value;
        const type = document.getElementById('specialDateType').value;
        
        if (!date) {
            showNotification('Please select a date', 'error');
            return;
        }
        
        showNotification(`Special date added: ${date} (${type})`, 'success');
        document.getElementById('specialDate').value = '';
    }

    // ===== Utility Functions =====
    function refreshCurrentView() {
        switch(currentView) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'bookings':
                loadBookings(currentPage);
                break;
            case 'availability':
                loadAvailabilityCalendar();
                break;
        }
        showNotification('Data refreshed!', 'success');
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function getServiceName(serviceType) {
        const services = {
            'regular': 'Regular Cleaning',
            'deep': 'Deep Cleaning',
            'end_tenancy': 'End of Tenancy',
            'carpet': 'Carpet Cleaning',
            'oven': 'Oven Cleaning',
            'office': 'Office Cleaning'
        };
        return services[serviceType] || serviceType;
    }

    function calculateNewPrice() {
        const serviceType = document.getElementById('newServiceType').value;
        const duration = parseInt(document.getElementById('newDuration').value);
        let price = 0;
        
        switch(serviceType) {
            case 'regular': price = duration * 18; break;
            case 'deep': price = duration * 25; break;
            case 'end_tenancy': price = duration * 30; break;
            case 'carpet': price = duration * 25; break;
            case 'oven': price = 45; break;
            case 'office': price = duration * 25; break;
        }
        
        document.getElementById('newPrice').value = price.toFixed(2);
        document.getElementById('newAmountPaid').value = '0';
    }

    function calculateEditPrice() {
        const serviceType = document.getElementById('editServiceType').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        let price = 0;
        
        switch(serviceType) {
            case 'regular': price = duration * 18; break;
            case 'deep': price = duration * 25; break;
            case 'end_tenancy': price = duration * 30; break;
            case 'carpet': price = duration * 25; break;
            case 'oven': price = 45; break;
            case 'office': price = duration * 25; break;
        }
        
        document.getElementById('editPrice').value = price.toFixed(2);
    }

    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        const title = document.getElementById('notificationTitle');
        const msg = document.getElementById('notificationMessage');
        
        let borderColor = 'var(--primary-green)';
        if (type === 'error') {
            borderColor = 'var(--red)';
            title.textContent = 'Error';
        } else if (type === 'warning') {
            borderColor = 'var(--orange)';
            title.textContent = 'Warning';
        } else if (type === 'info') {
            borderColor = 'var(--blue)';
            title.textContent = 'Info';
        } else {
            title.textContent = 'Success';
        }
        
        toast.style.borderLeftColor = borderColor;
        msg.textContent = message;
        toast.style.display = 'block';
        
        setTimeout(hideNotification, 5000);
    }

    function hideNotification() {
        document.getElementById('notificationToast').style.display = 'none';
    }

    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadBookings(1);
        }, 500);
    }

    // ===== Make functions available globally =====
    window.showBookingDetails = showBookingDetails;
    window.showEditBookingModal = showEditBookingModal;
    window.showDeleteConfirmation = showDeleteConfirmation;
    window.showSlotDetails = showSlotDetails;
    window.loadBookings = loadBookings;
    window.prevMonth = prevMonth;
    window.nextMonth = nextMonth;
    window.hideNotification = hideNotification;
</script>
