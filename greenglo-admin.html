<!-- Add to your services.html <head> -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Initialize Supabase client (REPLACE WITH YOUR KEYS)
const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co'; // Your project URL
const SUPABASE_PUBLISHABLE_KEY = 'sb_publishable_7TZ_Y-HKZc_ibl59lqyAsQ_Qbv9A2o7'; // Your publishable key

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

// Updated submitBooking() function
async function submitBooking() {
    const customerName = document.getElementById('customerName').value;
    const customerEmail = document.getElementById('customerEmail').value;
    const customerPhone = document.getElementById('customerPhone').value;
    const serviceAddress = document.getElementById('customerAddress').value;
    const specialInstructions = document.getElementById('specialInstructions').value;
    
    if (!currentBooking.timeSlot) {
        alert('Please select a time slot');
        return;
    }

    // 1. Insert booking into database
    const { data, error } = await supabase
        .from('bookings')
        .insert({
            customer_name: customerName,
            customer_email: customerEmail,
            customer_phone: customerPhone,
            service_address: serviceAddress,
            special_instructions: specialInstructions,
            booking_date: currentBooking.date.toISOString().split('T')[0],
            time_slot: currentBooking.timeSlot,
            service_type: currentBooking.service,
            status: 'pending'
        })
        .select(); // Returns the inserted row

    if (error) {
        console.error('Booking error:', error);
        alert('Failed to save booking. Please try again.');
        return;
    }

    // 2. Update availability
    await supabase
        .from('availability')
        .update({ is_available: false })
        .eq('date', currentBooking.date.toISOString().split('T')[0])
        .eq('time_slot', currentBooking.timeSlot);

    // 3. Trigger confirmation email via Edge Function
    const emailResponse = await fetch('https://faxjeniohetefqwcsefi.supabase.co/functions/v1/send-booking-confirm', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${SUPABASE_PUBLISHABLE_KEY}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            bookingId: data[0].id,
            customerEmail: customerEmail,
            customerName: customerName,
            serviceType: currentBooking.service,
            bookingDate: currentBooking.date.toLocaleDateString(),
            timeSlot: currentBooking.timeSlot
        })
    });

    if (emailResponse.ok) {
        // Show success message
        bookingForm.style.display = 'none';
        bookingConfirmation.classList.add('active');
    } else {
        console.error('Email trigger failed');
        alert('Booking saved but email confirmation failed.');
    }
}
</script>
