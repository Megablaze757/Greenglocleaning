<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>GreenGlo Admin | Availability Management</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-green: #10B981;
            --secondary-green: #34D399;
            --dark-green: #065F46;
            --light-green: #D1FAE5;
            --accent-green: #059669;
            --white: #FFFFFF;
            --off-white: #F9FAFB;
            --light-gray: #F3F4F6;
            --medium-gray: #9CA3AF;
            --dark-gray: #4B5563;
            --black: #111827;
            --red: #EF4444;
            --orange: #F59E0B;
            --blue: #3B82F6;
            --shadow: 0 10px 25px rgba(16, 185, 129, 0.12);
            --shadow-lg: 0 20px 40px rgba(16, 185, 129, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 16px;
            --gradient-primary: linear-gradient(135deg, var(--primary-green), #0D9488);
            --gradient-dark: linear-gradient(135deg, var(--dark-green), #0D9488);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.7;
            color: var(--dark-gray);
            background-color: var(--off-white);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: var(--gradient-dark);
            color: var(--white);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
        }

        .admin-sidebar-header {
            margin-bottom: 3rem;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .admin-logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .admin-logo-text h2 {
            color: var(--white);
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .admin-logo-text span {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .admin-nav {
            list-style: none;
            flex: 1;
        }

        .admin-nav-item {
            margin-bottom: 0.5rem;
        }

        .admin-nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: var(--transition);
        }

        .admin-nav-link:hover,
        .admin-nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .admin-nav-link i {
            width: 20px;
            text-align: center;
        }

        .admin-user {
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-avatar {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.25rem;
        }

        .admin-user-details h4 {
            color: var(--white);
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .admin-user-details span {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .admin-header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            color: var(--dark-green);
        }

        .last-updated {
            font-size: 0.875rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .last-updated i {
            color: var(--primary-green);
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(16, 185, 129, 0.1);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: var(--blue);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .stat-icon.orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .stat-icon.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .stat-trend {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .stat-trend.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .stat-trend.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-green);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--medium-gray);
        }

        /* Calendar Management */
        .calendar-management {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .calendar-header {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-header h3 {
            color: var(--white);
            font-size: 1.25rem;
            margin: 0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--white);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .current-month {
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            padding: 2rem;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: var(--white);
        }

        .calendar-day:hover {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .calendar-day.past {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--off-white);
        }

        .calendar-day.today {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .calendar-day.selected {
            border-color: var(--primary-green);
            background: var(--gradient-primary);
            color: var(--white);
        }

        .calendar-day.fully-booked {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.05);
        }

        .calendar-day.partially-available {
            border-color: var(--orange);
            background: rgba(245, 158, 11, 0.05);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .day-status {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            display: inline-block;
            font-weight: 600;
        }

        .status-available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .status-partial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .status-booked {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Time Slot Management */
        .time-slot-management {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .time-slot-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .time-slot-header h3 {
            color: var(--dark-green);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .time-slot-header p {
            color: var(--medium-gray);
            font-size: 0.875rem;
        }

        .time-slots-container {
            padding: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .time-slot-item {
            padding: 1rem;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
        }

        .time-slot-item:hover {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .time-slot-item.selected {
            border-color: var(--primary-green);
            background: var(--gradient-primary);
            color: var(--white);
        }

        .time-slot-time {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .time-slot-status {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            display: inline-block;
            font-weight: 600;
        }

        .time-slot-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-green);
            color: var(--primary-green);
        }

        .btn-outline:hover {
            background: var(--primary-green);
            color: var(--white);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
            border: 2px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            gap: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .settings-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .settings-section h3 {
            color: var(--dark-green);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--off-white);
            border-radius: 12px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-info h4 {
            color: var(--dark-gray);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .setting-info p {
            color: var(--medium-gray);
            font-size: 0.875rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray);
            transition: var(--transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--primary-green);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(30px);
        }

        /* Bookings Section */
        .bookings-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .booking-item {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .booking-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .booking-customer {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .booking-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
        }

        .booking-details {
            flex: 1;
        }

        .booking-name {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.25rem;
        }

        .booking-email {
            font-size: 0.875rem;
            color: var(--medium-gray);
        }

        .booking-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-confirmed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .booking-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .booking-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .booking-value {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .booking-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 250px;
            }

            .admin-main {
                margin-left: 250px;
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .admin-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1rem;
            }

            .admin-main {
                margin-left: 0;
                padding: 1rem;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .time-slots-grid {
                grid-template-columns: 1fr;
            }

            .calendar-days .calendar-day {
                aspect-ratio: 1.5;
            }

            .booking-info {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .calendar-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .calendar-nav {
                justify-content: space-between;
            }

            .time-slot-actions {
                flex-direction: column;
            }

            .time-slot-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .booking-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <a href="#" class="admin-logo">
                    <div class="admin-logo-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div class="admin-logo-text">
                        <h2>GreenGlo</h2>
                        <span>Admin Panel</span>
                    </div>
                </a>
            </div>

            <ul class="admin-nav">
                <li class="admin-nav-item">
                    <a href="#" class="admin-nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" class="admin-nav-link" data-section="calendar">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Calendar Management</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" class="admin-nav-link" data-section="timeSlots">
                        <i class="fas fa-clock"></i>
                        <span>Time Slots</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" class="admin-nav-link" data-section="bookings">
                        <i class="fas fa-book"></i>
                        <span>Bookings</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" class="admin-nav-link" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>

            <div class="admin-user">
                <div class="admin-user-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-user-details">
                        <h4 id="adminName">Administrator</h4>
                        <span id="adminRole">System Admin</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="admin-section">
                <div class="admin-header">
                    <h1>Dashboard Overview</h1>
                    <div class="last-updated">
                        <i class="fas fa-sync-alt"></i>
                        <span id="lastUpdatedTime">Loading...</span>
                    </div>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <span class="stat-trend up" id="todayTrend">+12%</span>
                        </div>
                        <div class="stat-value" id="todayBookings">0</div>
                        <div class="stat-label">Bookings Today</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="stat-trend up" id="weekTrend">+8%</span>
                        </div>
                        <div class="stat-value" id="availableSlots">0</div>
                        <div class="stat-label">Available Slots This Week</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span class="stat-trend down" id="pendingTrend">-5%</span>
                        </div>
                        <div class="stat-value" id="pendingRequests">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon red">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <span class="stat-trend down" id="blockedTrend">-3%</span>
                        </div>
                        <div class="stat-value" id="blockedSlots">0</div>
                        <div class="stat-label">Blocked Time Slots</div>
                    </div>
                </div>

                <div class="calendar-management">
                    <div class="calendar-header">
                        <h3>Upcoming Availability</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="prevWeek">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="current-month" id="currentWeekRange">This Week</div>
                            <button class="calendar-nav-btn" id="nextWeek">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div class="weekdays">
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                            <div class="weekday">Sun</div>
                        </div>
                        <div class="calendar-days" id="weekCalendar">
                            <!-- Week days will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Management Section -->
            <div id="calendarSection" class="admin-section" style="display: none;">
                <div class="admin-header">
                    <h1>Calendar Management</h1>
                    <div class="last-updated">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Manage availability for specific dates</span>
                    </div>
                </div>

                <div class="calendar-management">
                    <div class="calendar-header">
                        <h3>Monthly Calendar</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="prevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="current-month" id="currentMonth">December 2024</div>
                            <button class="calendar-nav-btn" id="nextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div class="weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                        </div>
                        <div class="calendar-days" id="monthCalendar">
                            <!-- Calendar days will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="time-slot-management">
                    <div class="time-slot-header">
                        <h3>Time Slots for <span id="selectedDate">No date selected</span></h3>
                        <p>Select a date from the calendar above to manage time slots</p>
                    </div>

                    <div class="loading-spinner" id="timeSlotsLoading">
                        <div class="spinner"></div>
                        <p>Loading time slots...</p>
                    </div>

                    <div class="time-slots-container" id="timeSlotsContainer" style="display: none;">
                        <div class="time-slots-grid" id="timeSlotsGrid">
                            <!-- Time slots will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="time-slot-actions" id="timeSlotActions" style="display: none;">
                        <button class="btn btn-primary" id="saveTimeSlots">
                            <i class="fas fa-save"></i>
                            Save Changes
                        </button>
                        <button class="btn btn-outline" id="selectAllSlots">
                            <i class="fas fa-check-square"></i>
                            Select All
                        </button>
                        <button class="btn btn-outline" id="deselectAllSlots">
                            <i class="fas fa-square"></i>
                            Deselect All
                        </button>
                        <button class="btn btn-danger" id="blockDate">
                            <i class="fas fa-ban"></i>
                            Block Entire Day
                        </button>
                    </div>
                </div>
            </div>

            <!-- Time Slots Section -->
            <div id="timeSlotsSection" class="admin-section" style="display: none;">
                <div class="admin-header">
                    <h1>Time Slot Templates</h1>
                    <div class="last-updated">
                        <i class="fas fa-clock"></i>
                        <span>Manage default time slot templates</span>
                    </div>
                </div>

                <div class="time-slot-management">
                    <div class="time-slot-header">
                        <h3>Default Time Slots</h3>
                        <p>These slots will be available by default on all days unless overridden</p>
                    </div>

                    <div class="time-slots-container">
                        <div class="time-slots-grid" id="defaultTimeSlots">
                            <!-- Default time slots will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="time-slot-actions">
                        <button class="btn btn-primary" id="saveDefaultSlots">
                            <i class="fas fa-save"></i>
                            Save Template
                        </button>
                        <button class="btn btn-outline" id="addCustomSlot">
                            <i class="fas fa-plus"></i>
                            Add Custom Slot
                        </button>
                        <button class="btn btn-danger" id="resetToDefault">
                            <i class="fas fa-undo"></i>
                            Reset to Default
                        </button>
                    </div>
                </div>

                <div class="settings-panel">
                    <div class="settings-section">
                        <h3>Slot Duration Settings</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Default Slot Duration</h4>
                                <p>Set the default duration for each time slot</p>
                            </div>
                            <select id="slotDuration" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="2">2 hours</option>
                                <option value="3">3 hours</option>
                                <option value="4">4 hours</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Working Hours</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Start Time</h4>
                                <p>Earliest available booking time</p>
                            </div>
                            <select id="startTime" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="8">8:00 AM</option>
                                <option value="9">9:00 AM</option>
                                <option value="10">10:00 AM</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>End Time</h4>
                                <p>Latest available booking time</p>
                            </div>
                            <select id="endTime" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="18">6:00 PM</option>
                                <option value="19">7:00 PM</option>
                                <option value="20">8:00 PM</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings Section -->
            <div id="bookingsSection" class="admin-section" style="display: none;">
                <div class="admin-header">
                    <h1>Bookings Management</h1>
                    <div class="last-updated">
                        <i class="fas fa-calendar-check"></i>
                        <span>View and manage customer bookings</span>
                    </div>
                </div>

                <div class="calendar-management">
                    <div class="calendar-header">
                        <h3>Recent Bookings</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="refreshBookings">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div id="bookingsList" class="bookings-container" style="padding: 2rem;">
                            <!-- Bookings will be populated here -->
                            <div class="loading-spinner" id="bookingsLoading">
                                <div class="spinner"></div>
                                <p>Loading bookings...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="admin-section" style="display: none;">
                <div class="admin-header">
                    <h1>System Settings</h1>
                    <div class="last-updated">
                        <i class="fas fa-cog"></i>
                        <span>Configure system preferences</span>
                    </div>
                </div>

                <div class="settings-panel">
                    <div class="settings-section">
                        <h3>General Settings</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Enable Automatic Sync</h4>
                                <p>Automatically sync changes across all users</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoSync" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Send Email Notifications</h4>
                                <p>Get notified when bookings are made</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Show Unavailable Dates</h4>
                                <p>Display blocked dates on the calendar</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showUnavailable" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Booking Settings</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Minimum Booking Notice</h4>
                                <p>Minimum hours before a booking can be made</p>
                            </div>
                            <select id="minNotice" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="2">2 hours</option>
                                <option value="4">4 hours</option>
                                <option value="24">24 hours</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Maximum Advance Booking</h4>
                                <p>How far in advance customers can book</p>
                            </div>
                            <select id="maxAdvance" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="30">30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Same-day Booking</h4>
                                <p>Allow bookings for the same day</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sameDayBooking" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Database Management</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Backup Schedule</h4>
                                <p>Automatically backup data</p>
                            </div>
                            <select id="backupSchedule" class="btn btn-outline" style="padding: 0.5rem 1rem;">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Clear Old Data</h4>
                                <p>Remove bookings older than 90 days</p>
                            </div>
                            <button class="btn btn-danger" id="clearOldData">
                                <i class="fas fa-trash"></i>
                                Clear Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===== Supabase Configuration =====
        const SUPABASE_URL = "https://faxjeniohetefqwcsefi.supabase.co";
        const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_7TZ_Y-HKZc_ibl59lqyAsQ_Qbv9A2o7";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

        // ===== Global Variables =====
        let selectedDate = null;
        let currentView = 'dashboard';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let weekOffset = 0;
        let realtimeSubscriptions = [];

        // ===== Default Time Slots =====
        const defaultTimeSlots = [
            { start_time: "08:00:00", end_time: "10:00:00", label: "Morning", is_default: true },
            { start_time: "10:00:00", end_time: "12:00:00", label: "Late Morning", is_default: true },
            { start_time: "12:00:00", end_time: "14:00:00", label: "Afternoon", is_default: true },
            { start_time: "14:00:00", end_time: "16:00:00", label: "Mid Afternoon", is_default: true },
            { start_time: "16:00:00", end_time: "18:00:00", label: "Evening", is_default: true },
            { start_time: "18:00:00", end_time: "20:00:00", label: "Late Evening", is_default: true }
        ];

        // ===== UI Functions =====
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + 'Section').style.display = 'block';

            // Add active class to selected nav link
            document.querySelector(`.admin-nav-link[data-section="${sectionName}"]`).classList.add('active');

            currentView = sectionName;

            // Load section-specific data
            switch (sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'calendar':
                    loadCalendarData();
                    break;
                case 'timeSlots':
                    loadTimeSlotsData();
                    break;
                case 'bookings':
                    loadBookingsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        // Navigation click handlers
        document.querySelectorAll('.admin-nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                showSection(section);
            });
        });

        // ===== Dashboard Functions =====
        async function loadDashboardData() {
            updateLastUpdatedTime();
            await loadWeekCalendar();
            await updateDashboardStats();
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdatedTime').textContent = `Last updated: ${timeString}`;
        }

        async function loadWeekCalendar() {
            const calendarDays = document.getElementById('weekCalendar');
            calendarDays.innerHTML = '';

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (weekOffset * 7)); // Start from Monday

            // Update week range display
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const startStr = startOfWeek.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const endStr = endOfWeek.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            document.getElementById('currentWeekRange').textContent = `${startStr} - ${endStr}`;

            // Generate week days
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                // Check if today
                if (day.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // Check if past date
                if (day < today && day.toDateString() !== today.toDateString()) {
                    dayElement.classList.add('past');
                }

                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day.getDate();
                dayElement.appendChild(dayNumber);

                // Add day name
                const dayName = document.createElement('div');
                dayName.className = 'day-weekday';
                dayName.textContent = day.toLocaleDateString('en-GB', { weekday: 'short' });
                dayElement.appendChild(dayName);

                // Load availability status from Supabase
                try {
                    const dateString = day.toISOString().split('T')[0];
                    const { data: slots, error } = await supabase
                        .from('availability_slots')
                        .select('*')
                        .eq('slot_date', dateString);

                    if (!error && slots && slots.length > 0) {
                        const availableSlots = slots.filter(slot => 
                            !slot.is_blocked && slot.booked_count < slot.max_capacity
                        ).length;
                        const totalSlots = slots.length;

                        const status = document.createElement('div');
                        status.className = 'day-status';

                        if (availableSlots === 0) {
                            status.classList.add('status-booked');
                            status.textContent = 'Fully Booked';
                            dayElement.classList.add('fully-booked');
                        } else if (availableSlots === totalSlots) {
                            status.classList.add('status-available');
                            status.textContent = 'Available';
                            dayElement.classList.add('partially-available');
                        } else {
                            status.classList.add('status-partial');
                            status.textContent = `${availableSlots}/${totalSlots} Available`;
                            dayElement.classList.add('partially-available');
                        }

                        dayElement.appendChild(status);
                    } else {
                        const status = document.createElement('div');
                        status.className = 'day-status status-available';
                        status.textContent = 'Available';
                        dayElement.appendChild(status);
                    }
                } catch (error) {
                    console.error('Error loading day status:', error);
                }

                calendarDays.appendChild(dayElement);
            }
        }

        async function updateDashboardStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Get today's bookings
                const { data: todayBookings, error: bookingsError } = await supabase
                    .from('bookings')
                    .select('*', { count: 'exact' })
                    .eq('booking_date', today)
                    .eq('status', 'confirmed');

                if (!bookingsError) {
                    document.getElementById('todayBookings').textContent = todayBookings?.length || 0;
                }

                // Get available slots this week
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);

                const { data: weekSlots, error: slotsError } = await supabase
                    .from('availability_slots')
                    .select('*')
                    .gte('slot_date', startOfWeek.toISOString().split('T')[0])
                    .lte('slot_date', endOfWeek.toISOString().split('T')[0])
                    .lt('booked_count', supabase.raw('max_capacity'))
                    .eq('is_blocked', false);

                if (!slotsError) {
                    document.getElementById('availableSlots').textContent = weekSlots?.length || 0;
                }

                // Get pending requests
                const { data: pendingRequests, error: pendingError } = await supabase
                    .from('bookings')
                    .select('*', { count: 'exact' })
                    .eq('status', 'pending');

                if (!pendingError) {
                    document.getElementById('pendingRequests').textContent = pendingRequests?.length || 0;
                }

                // Get blocked slots
                const { data: blockedSlots, error: blockedError } = await supabase
                    .from('availability_slots')
                    .select('*', { count: 'exact' })
                    .eq('is_blocked', true);

                if (!blockedError) {
                    document.getElementById('blockedSlots').textContent = blockedSlots?.length || 0;
                }

            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Week navigation
        document.getElementById('prevWeek').addEventListener('click', () => {
            weekOffset--;
            loadWeekCalendar();
        });

        document.getElementById('nextWeek').addEventListener('click', () => {
            weekOffset++;
            loadWeekCalendar();
        });

        // ===== Calendar Functions =====
        function loadCalendarData() {
            renderMonthCalendar();
        }

        function renderMonthCalendar() {
            const calendarDays = document.getElementById('monthCalendar');
            calendarDays.innerHTML = '';

            // Get first day of month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);

            // Update month display
            const monthName = firstDay.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonth').textContent = monthName;

            // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
            let firstDayIndex = firstDay.getDay();

            // Add empty cells for days before first day of month
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day past';
                calendarDays.appendChild(emptyDay);
            }

            // Add days of month
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.dataset.date = date.toISOString().split('T')[0];

                // Check if today
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // Check if past date
                if (date < today && date.toDateString() !== today.toDateString()) {
                    dayElement.classList.add('past');
                }

                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                // Add click event
                dayElement.addEventListener('click', async () => {
                    if (!dayElement.classList.contains('past')) {
                        await selectDate(date);
                    }
                });

                calendarDays.appendChild(dayElement);
            }
        }

        async function selectDate(date) {
            selectedDate = date;

            // Remove selected class from all days
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });

            // Add selected class to clicked day
            const dateString = date.toISOString().split('T')[0];
            const dayElement = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (dayElement) {
                dayElement.classList.add('selected');
            }

            // Update selected date display
            const dateDisplay = date.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('selectedDate').textContent = dateDisplay;

            // Load time slots for selected date
            await loadTimeSlotsForDate(date);
        }

        // Month navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderMonthCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderMonthCalendar();
        });

        // ===== Time Slots Functions =====
        async function loadTimeSlotsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            
            // Show loading
            document.getElementById('timeSlotsLoading').style.display = 'flex';
            document.getElementById('timeSlotsContainer').style.display = 'none';
            document.getElementById('timeSlotActions').style.display = 'none';

            try {
                // Fetch availability for the selected date 
                const { data: slots, error } = await supabase
                    .from('availability_slots')
                    .select('*')
                    .eq('slot_date', dateString)
                    .order('start_time');

                if (error) throw error;

                // If no slots exist, generate them from templates
                if (!slots || slots.length === 0) {
                    await generateSlotsForDate(date);
                    // Fetch again
                    const { data: newSlots } = await supabase
                        .from('availability_slots')
                        .select('*')
                        .eq('slot_date', dateString)
                        .order('start_time');
                    renderTimeSlots(newSlots || []);
                } else {
                    renderTimeSlots(slots);
                }

                // Hide loading, show slots
                document.getElementById('timeSlotsLoading').style.display = 'none';
                document.getElementById('timeSlotsContainer').style.display = 'block';
                document.getElementById('timeSlotActions').style.display = 'flex';

            } catch (error) {
                console.error('Error loading time slots:', error);
                alert('Failed to load time slots');
            }
        }

        async function generateSlotsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            const dayOfWeek = date.getDay();
            
            try {
                // Get templates for this day of week
                const { data: templates, error } = await supabase
                    .from('time_slot_templates')
                    .select('*')
                    .eq('enabled', true)
                    .or(`day_of_week.is.null,day_of_week.eq.${dayOfWeek}`);

                if (error) throw error;

                // Create slots from templates
                for (const template of templates || []) {
                    const { error: insertError } = await supabase
                        .from('availability_slots')
                        .upsert({
                            slot_date: dateString,
                            start_time: template.start_time,
                            end_time: template.end_time,
                            max_capacity: 1,
                            booked_count: 0,
                            is_blocked: false
                        }, { 
                            onConflict: 'slot_date,start_time,end_time',
                            ignoreDuplicates: false
                        });

                    if (insertError) {
                        console.error('Error creating slot:', insertError);
                    }
                }
            } catch (error) {
                console.error('Error generating slots:', error);
            }
        }

        function renderTimeSlots(slots) {
            const container = document.getElementById('timeSlotsGrid');
            container.innerHTML = '';

            slots.forEach(slot => {
                const startTime = slot.start_time.substring(0, 5);
                const endTime = slot.end_time.substring(0, 5);
                const isAvailable = !slot.is_blocked && slot.booked_count < slot.max_capacity;
                
                const slotElement = document.createElement('div');
                slotElement.className = `time-slot-item ${isAvailable ? 'selected' : ''}`;
                slotElement.dataset.id = slot.id;
                slotElement.dataset.available = isAvailable;

                slotElement.innerHTML = `
                    <div class="time-slot-time">${startTime}-${endTime}</div>
                    <div class="time-slot-status ${isAvailable ? 'status-available' : 'status-booked'}">
                        ${isAvailable ? 'Available' : slot.is_blocked ? 'Blocked' : 'Booked'} (${slot.booked_count}/${slot.max_capacity})
                    </div>
                    <div class="time-slot-label">${slot.label || 'Slot'}</div>
                `;

                slotElement.addEventListener('click', async () => {
                    if (!slot.is_blocked) {
                        await toggleSlotAvailability(slot.id, !isAvailable);
                    }
                });

                container.appendChild(slotElement);
            });
        }

        async function toggleSlotAvailability(slotId, makeAvailable) {
            try {
                const { error } = await supabase
                    .from('availability_slots')
                    .update({ is_blocked: !makeAvailable })
                    .eq('id', slotId);

                if (error) throw error;
                
                // Reload slots
                if (selectedDate) {
                    await loadTimeSlotsForDate(selectedDate);
                }
                await updateDashboardStats();
            } catch (error) {
                console.error('Error updating slot:', error);
                alert('Failed to update slot availability');
            }
        }

        // Time slot actions
        document.getElementById('saveTimeSlots').addEventListener('click', async () => {
            if (!selectedDate) {
                alert('Please select a date first');
                return;
            }
            
            const slotElements = document.querySelectorAll('#timeSlotsGrid .time-slot-item');
            
            try {
                for (const element of slotElements) {
                    const { error } = await supabase
                        .from('availability_slots')
                        .update({ 
                            is_blocked: element.dataset.available === 'false'
                        })
                        .eq('id', element.dataset.id);
                    
                    if (error) throw error;
                }
                
                alert('Time slots saved successfully!');
                await updateDashboardStats();
            } catch (error) {
                console.error('Error saving slots:', error);
                alert('Failed to save time slots');
            }
        });

        document.getElementById('selectAllSlots').addEventListener('click', () => {
            document.querySelectorAll('.time-slot-item').forEach(element => {
                element.dataset.available = 'true';
                element.classList.add('selected');
                const status = element.querySelector('.time-slot-status');
                status.textContent = 'Available';
                status.className = 'time-slot-status status-available';
            });
        });

        document.getElementById('deselectAllSlots').addEventListener('click', () => {
            document.querySelectorAll('.time-slot-item').forEach(element => {
                element.dataset.available = 'false';
                element.classList.remove('selected');
                const status = element.querySelector('.time-slot-status');
                status.textContent = 'Blocked';
                status.className = 'time-slot-status status-booked';
            });
        });

        document.getElementById('blockDate').addEventListener('click', async () => {
            if (!selectedDate || !confirm('Block all time slots for this day?')) return;
            
            const dateString = selectedDate.toISOString().split('T')[0];
            
            try {
                const { error } = await supabase
                    .from('availability_slots')
                    .update({ is_blocked: true })
                    .eq('slot_date', dateString);
                
                if (error) throw error;
                
                alert('Day blocked successfully!');
                await loadTimeSlotsForDate(selectedDate);
                await updateDashboardStats();
            } catch (error) {
                console.error('Error blocking day:', error);
                alert('Failed to block day');
            }
        });

        // ===== Default Time Slots Functions =====
        async function loadTimeSlotsData() {
            await renderDefaultTimeSlots();
            loadSettings();
        }

        async function renderDefaultTimeSlots() {
            const container = document.getElementById('defaultTimeSlots');
            container.innerHTML = '';

            try {
                const { data: templates, error } = await supabase
                    .from('time_slot_templates')
                    .select('*')
                    .eq('is_default', true)
                    .order('start_time');

                if (error) throw error;

                if (!templates || templates.length === 0) {
                    // Insert default templates if none exist
                    for (const slot of defaultTimeSlots) {
                        await supabase
                            .from('time_slot_templates')
                            .insert(slot);
                    }
                    // Fetch again
                    const { data: newTemplates } = await supabase
                        .from('time_slot_templates')
                        .select('*')
                        .eq('is_default', true)
                        .order('start_time');
                    renderTemplateSlots(newTemplates || []);
                } else {
                    renderTemplateSlots(templates);
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                renderTemplateSlots(defaultTimeSlots);
            }
        }

        function renderTemplateSlots(templates) {
            const container = document.getElementById('defaultTimeSlots');
            container.innerHTML = '';

            templates.forEach(template => {
                const startTime = template.start_time.substring(0, 5);
                const endTime = template.end_time.substring(0, 5);
                
                const slotElement = document.createElement('div');
                slotElement.className = `time-slot-item ${template.enabled ? 'selected' : ''}`;
                slotElement.dataset.id = template.id;
                slotElement.dataset.enabled = template.enabled;

                slotElement.innerHTML = `
                    <div class="time-slot-time">${startTime}-${endTime}</div>
                    <div class="time-slot-status ${template.enabled ? 'status-available' : 'status-booked'}">
                        ${template.enabled ? 'Enabled' : 'Disabled'}
                    </div>
                    <div class="time-slot-label">${template.label}</div>
                `;

                slotElement.addEventListener('click', async () => {
                    await toggleTemplateStatus(template.id, !template.enabled);
                });

                container.appendChild(slotElement);
            });
        }

        async function toggleTemplateStatus(templateId, enable) {
            try {
                const { error } = await supabase
                    .from('time_slot_templates')
                    .update({ enabled: enable })
                    .eq('id', templateId);

                if (error) throw error;
                
                await renderDefaultTimeSlots();
            } catch (error) {
                console.error('Error updating template:', error);
                alert('Failed to update template status');
            }
        }

        // Default slot actions
        document.getElementById('saveDefaultSlots').addEventListener('click', async () => {
            alert('Template settings saved!');
        });

        document.getElementById('addCustomSlot').addEventListener('click', async () => {
            const time = prompt('Enter time slot (e.g., 09:00-11:00):');
            const label = prompt('Enter label (e.g., Early Morning):');

            if (time && label) {
                const [start, end] = time.split('-');
                
                try {
                    const { error } = await supabase
                        .from('time_slot_templates')
                        .insert({
                            start_time: start + ':00',
                            end_time: end + ':00',
                            label: label,
                            is_default: false,
                            enabled: true
                        });

                    if (error) throw error;
                    
                    alert('Custom slot added!');
                    await renderDefaultTimeSlots();
                } catch (error) {
                    console.error('Error adding custom slot:', error);
                    alert('Failed to add custom slot');
                }
            }
        });

        document.getElementById('resetToDefault').addEventListener('click', async () => {
            if (confirm('Reset to default time slots?')) {
                try {
                    // Delete all non-default templates
                    const { error } = await supabase
                        .from('time_slot_templates')
                        .delete()
                        .eq('is_default', false);

                    if (error) throw error;
                    
                    // Reset default templates to enabled
                    const { error: updateError } = await supabase
                        .from('time_slot_templates')
                        .update({ enabled: true })
                        .eq('is_default', true);

                    if (updateError) throw updateError;
                    
                    await renderDefaultTimeSlots();
                    alert('Reset to default slots!');
                } catch (error) {
                    console.error('Error resetting templates:', error);
                    alert('Failed to reset templates');
                }
            }
        });

        // ===== Bookings Functions =====
        async function loadBookingsData() {
            await loadRecentBookings();
        }

        async function loadRecentBookings() {
            const bookingsList = document.getElementById('bookingsList');
            const bookingsLoading = document.getElementById('bookingsLoading');
            
            try {
                // Show loading
                bookingsLoading.style.display = 'flex';
                bookingsList.innerHTML = '';

                // Fetch recent bookings
                const { data: bookings, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .order('booking_date', { ascending: false })
                    .order('start_time', { ascending: false })
                    .limit(20);

                if (error) throw error;

                // Hide loading
                bookingsLoading.style.display = 'none';

                if (!bookings || bookings.length === 0) {
                    bookingsList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--medium-gray);">
                            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>No bookings found</h3>
                            <p>There are no bookings in the system yet.</p>
                        </div>
                    `;
                    return;
                }

                // Render bookings
                bookings.forEach(booking => {
                    const bookingElement = document.createElement('div');
                    bookingElement.className = 'booking-item';
                    
                    const bookingDate = new Date(booking.booking_date);
                    const formattedDate = bookingDate.toLocaleDateString('en-GB', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    const startTime = booking.start_time.substring(0, 5);
                    const endTime = booking.end_time.substring(0, 5);
                    const initials = booking.customer_name.split(' ')
                        .map(n => n[0])
                        .join('')
                        .toUpperCase();

                    bookingElement.innerHTML = `
                        <div class="booking-header">
                            <div class="booking-customer">
                                <div class="booking-avatar">${initials}</div>
                                <div class="booking-details">
                                    <div class="booking-name">${booking.customer_name}</div>
                                    <div class="booking-email">${booking.customer_email}</div>
                                </div>
                            </div>
                            <div class="booking-status status-${booking.status}">
                                ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                            </div>
                        </div>
                        <div class="booking-info">
                            <div class="booking-info-item">
                                <span class="booking-label">Date</span>
                                <span class="booking-value">${formattedDate}</span>
                            </div>
                            <div class="booking-info-item">
                                <span class="booking-label">Time</span>
                                <span class="booking-value">${startTime} - ${endTime}</span>
                            </div>
                            <div class="booking-info-item">
                                <span class="booking-label">Service</span>
                                <span class="booking-value">${booking.service_type}</span>
                            </div>
                        </div>
                        ${booking.notes ? `
                            <div class="booking-info-item" style="margin-bottom: 1rem;">
                                <span class="booking-label">Notes</span>
                                <span class="booking-value">${booking.notes}</span>
                            </div>
                        ` : ''}
                        <div class="booking-actions">
                            <button class="btn btn-outline btn-sm" onclick="updateBookingStatus('${booking.id}', 'confirmed')">
                                Confirm
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="updateBookingStatus('${booking.id}', 'cancelled')">
                                Cancel
                            </button>
                        </div>
                    `;
                    
                    bookingsList.appendChild(bookingElement);
                });

            } catch (error) {
                console.error('Error loading bookings:', error);
                bookingsLoading.style.display = 'none';
                bookingsList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--red);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Error loading bookings</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Make updateBookingStatus globally accessible
        window.updateBookingStatus = async function(bookingId, status) {
            try {
                const { error } = await supabase
                    .from('bookings')
                    .update({ status: status })
                    .eq('id', bookingId);

                if (error) throw error;
                
                alert(`Booking ${status} successfully!`);
                await loadRecentBookings();
                await updateDashboardStats();
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Failed to update booking status');
            }
        };

        document.getElementById('refreshBookings').addEventListener('click', async () => {
            await loadRecentBookings();
        });

        // ===== Settings Functions =====
        function loadSettingsData() {
            loadSettings();
        }

        function loadSettings() {
            // Load saved settings from localStorage
            const settings = JSON.parse(localStorage.getItem('greenglo_settings')) || {};

            // Apply settings to form elements
            if (settings.slotDuration) {
                document.getElementById('slotDuration').value = settings.slotDuration;
            }

            if (settings.startTime) {
                document.getElementById('startTime').value = settings.startTime;
            }

            if (settings.endTime) {
                document.getElementById('endTime').value = settings.endTime;
            }

            if (settings.minNotice) {
                document.getElementById('minNotice').value = settings.minNotice;
            }

            if (settings.maxAdvance) {
                document.getElementById('maxAdvance').value = settings.maxAdvance;
            }

            if (settings.backupSchedule) {
                document.getElementById('backupSchedule').value = settings.backupSchedule;
            }

            // Toggle switches
            const toggles = ['autoSync', 'emailNotifications', 'showUnavailable', 'sameDayBooking'];
            toggles.forEach(toggleId => {
                const element = document.getElementById(toggleId);
                if (element && settings[toggleId] !== undefined) {
                    element.checked = settings[toggleId];
                }
            });

            // Add change listeners to save settings
            const saveSetting = (key, value) => {
                const settings = JSON.parse(localStorage.getItem('greenglo_settings')) || {};
                settings[key] = value;
                localStorage.setItem('greenglo_settings', JSON.stringify(settings));
            };

            // Listen for changes
            document.querySelectorAll('select, input[type="checkbox"]').forEach(element => {
                element.addEventListener('change', function() {
                    if (this.type === 'checkbox') {
                        saveSetting(this.id, this.checked);
                    } else {
                        saveSetting(this.id, this.value);
                    }
                });
            });
        }

        // Clear old data
        document.getElementById('clearOldData').addEventListener('click', async () => {
            if (confirm('Clear all data older than 90 days? This action cannot be undone.')) {
                try {
                    const ninetyDaysAgo = new Date();
                    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                    const dateString = ninetyDaysAgo.toISOString().split('T')[0];

                    // Delete old bookings
                    const { error: bookingsError } = await supabase
                        .from('bookings')
                        .delete()
                        .lt('booking_date', dateString);

                    if (bookingsError) throw bookingsError;

                    // Delete old availability slots
                    const { error: slotsError } = await supabase
                        .from('availability_slots')
                        .delete()
                        .lt('slot_date', dateString);

                    if (slotsError) throw slotsError;

                    alert('Old data cleared successfully!');
                    await updateDashboardStats();
                    if (currentView === 'bookings') {
                        await loadRecentBookings();
                    }
                } catch (error) {
                    console.error('Error clearing old data:', error);
                    alert('Failed to clear old data');
                }
            }
        });

        // ===== Real-time Updates =====
        function setupRealtimeSubscriptions() {
            // Clear existing subscriptions
            realtimeSubscriptions.forEach(sub => sub.unsubscribe());
            realtimeSubscriptions = [];

            // Subscribe to bookings changes
            const bookingsSubscription = supabase
                .channel('bookings-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'bookings' },
                    async (payload) => {
                        console.log('Bookings changed:', payload);
                        if (currentView === 'dashboard' || currentView === 'bookings') {
                            await updateDashboardStats();
                            if (currentView === 'bookings') {
                                await loadRecentBookings();
                            }
                        }
                    }
                )
                .subscribe();

            // Subscribe to availability changes
            const availabilitySubscription = supabase
                .channel('availability-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'availability_slots' },
                    async (payload) => {
                        console.log('Availability changed:', payload);
                        if (selectedDate && currentView === 'calendar') {
                            await loadTimeSlotsForDate(selectedDate);
                        }
                        if (currentView === 'dashboard') {
                            await updateDashboardStats();
                            await loadWeekCalendar();
                        }
                    }
                )
                .subscribe();

            realtimeSubscriptions.push(bookingsSubscription, availabilitySubscription);
        }

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Show dashboard by default
            showSection('dashboard');
            
            // Setup real-time subscriptions
            setupRealtimeSubscriptions();
            
            // Update stats every minute
            setInterval(async () => {
                updateLastUpdatedTime();
                if (currentView === 'dashboard') {
                    await updateDashboardStats();
                }
            }, 60000);
            
            // Initialize week navigation
            document.getElementById('prevWeek').addEventListener('click', async () => {
                weekOffset--;
                await loadWeekCalendar();
            });

            document.getElementById('nextWeek').addEventListener('click', async () => {
                weekOffset++;
                await loadWeekCalendar();
            });
        });
    </script>
</body>
</html>
