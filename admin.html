<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenGlo Admin | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #10B981;
            --dark-green: #065F46;
            --light-green: #D1FAE5;
            --white: #FFFFFF;
            --off-white: #F9FAFB;
            --light-gray: #F3F4F6;
            --medium-gray: #9CA3AF;
            --dark-gray: #4B5563;
            --red: #EF4444;
            --orange: #F59E0B;
            --blue: #3B82F6;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--off-white); color: var(--dark-gray); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--dark-green), var(--primary-green));
            color: white; padding: 1.5rem 2rem; border-radius: var(--border-radius);
            margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;
        }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .logo-text h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark-green); margin-bottom: 0.5rem; }
        .stat-label { color: var(--medium-gray); font-size: 0.875rem; }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
        .card-header { background: var(--primary-green); color: white; padding: 1.25rem 1.5rem; }
        .card-header h3 { font-size: 1.25rem; margin: 0; display: flex; justify-content: space-between; align-items: center; }
        .card-content { padding: 1.5rem; max-height: 500px; overflow-y: auto; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 1rem; background: var(--light-gray); font-weight: 600; border-bottom: 2px solid var(--medium-gray); }
        td { padding: 1rem; border-bottom: 1px solid var(--light-gray); }
        tr:hover { background: var(--off-white); }

        /* Status Badges */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .status-pending { background: rgba(245, 158, 11, 0.1); color: var(--orange); }
        .status-confirmed { background: rgba(16, 185, 129, 0.1); color: var(--primary-green); }
        .status-cancelled { background: rgba(239, 68, 68, 0.1); color: var(--red); }

        /* Calendar & Time Slots */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 1.5rem; }
        .calendar-day { aspect-ratio: 1; border: 2px solid var(--light-gray); border-radius: 8px; padding: 0.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .calendar-day:hover { border-color: var(--primary-green); }
        .calendar-day.selected { background: var(--primary-green); color: white; border-color: var(--primary-green); }
        .calendar-day.unavailable { background: var(--off-white); color: var(--medium-gray); cursor: not-allowed; opacity: 0.5; }
        .calendar-day.today { border-color: var(--primary-green); }

        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; margin-top: 1rem; }
        .time-slot { padding: 0.75rem; border: 2px solid var(--light-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .time-slot:hover { border-color: var(--primary-green); }
        .time-slot.selected { background: var(--primary-green); color: white; border-color: var(--primary-green); }
        .time-slot.unavailable { background: rgba(239, 68, 68, 0.1); border-color: var(--red); cursor: not-allowed; }

        /* Buttons */
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary-green); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-green); color: var(--primary-green); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 2px solid rgba(239, 68, 68, 0.2); }

        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; gap: 1rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--light-gray); border-top: 4px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Alerts */
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; align-items: center; gap: 0.75rem; }
        .alert-success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--primary-green); color: var(--dark-green); display: flex; }
        .alert-error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red); color: var(--red); display: flex; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-leaf"></i></div>
                <div class="logo-text">
                    <h1>GreenGlo Admin Dashboard</h1>
                    <span>Direct Management Panel</span>
                </div>
            </div>
            <div id="lastUpdated" style="font-size: 0.875rem; opacity: 0.9;">Loading...</div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="todayBookings">0</div>
                <div class="stat-label">Today's Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingBookings">0</div>
                <div class="stat-label">Pending Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="availableSlots">0</div>
                <div class="stat-label">Available Slots</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalBookings">0</div>
                <div class="stat-label">Total Bookings</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Bookings Panel -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-calendar-check"></i> Recent Bookings
                        <select id="bookingFilter" style="padding: 0.25rem 0.5rem; border-radius: 6px; border: none; font-size: 0.875rem;">
                            <option value="all">All</option>
                            <option value="today">Today</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                    </h3>
                </div>
                <div class="card-content">
                    <div id="bookingsLoading" class="loading">
                        <div class="spinner"></div>
                        <p>Loading bookings...</p>
                    </div>
                    <div class="table-container" id="bookingsTable" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Availability Panel -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-clock"></i> Manage Availability
                        <button class="btn btn-primary" onclick="showAddSlotModal()" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </h3>
                </div>
                <div class="card-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <button class="btn btn-outline" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h4 id="currentMonth" style="margin: 0;">December 2024</h4>
                        <button class="btn btn-outline" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendar"></div>
                    <div id="timeSlotsSection" style="display: none; margin-top: 1.5rem;">
                        <h4>Time slots for <span id="selectedDateText">Selected Date</span></h4>
                        <div class="time-slots-grid" id="timeSlots"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Slot Modal -->
        <div id="addSlotModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 400px; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Add Time Slot</h3>
                    <button onclick="closeModal('addSlotModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <form id="addSlotForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date</label>
                        <input type="date" id="slotDate" required style="width: 100%; padding: 0.5rem; border: 2px solid var(--light-gray); border-radius: 8px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start Time</label>
                            <input type="time" id="slotStartTime" required style="width: 100%; padding: 0.5rem; border: 2px solid var(--light-gray); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">End Time</label>
                            <input type="time" id="slotEndTime" required style="width: 100%; padding: 0.5rem; border: 2px solid var(--light-gray); border-radius: 8px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Max Capacity</label>
                        <input type="number" id="slotCapacity" min="1" value="1" required style="width: 100%; padding: 0.5rem; border: 2px solid var(--light-gray); border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Add Slot</button>
                </form>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1001; min-width: 300px;"></div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        // Replace with your actual Supabase credentials
        const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co';
        const SUPABASE_PUBLISHABLE_KEY = 'sb_publishable_7TZ_Y-HKZc_ibl59lqyAsQ_Qbv9A2o7';
        
        // Initialize Supabase client[citation:1]
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

        // ===== GLOBAL VARIABLES =====
        let selectedDate = new Date();
        let currentMonth = selectedDate.getMonth();
        let currentYear = selectedDate.getFullYear();
        let selectedSlotId = null;

        // ===== INITIAL LOAD =====
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            updateLastUpdated();
            setupEventListeners();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('slotDate').value = today;
            document.getElementById('slotStartTime').value = '09:00';
            document.getElementById('slotEndTime').value = '11:00';
        });

        // ===== DASHBOARD FUNCTIONS =====
        async function loadDashboardData() {
            await Promise.all([
                loadStats(),
                loadBookings(),
                renderCalendar()
            ]);
        }

        async function loadStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Get today's bookings[citation:1]
                const { count: todayCount } = await supabase
                    .from('bookings')
                    .select('*', { count: 'exact', head: true })
                    .eq('booking_date', today);
                
                // Get pending bookings
                const { count: pendingCount } = await supabase
                    .from('bookings')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');
                
                // Get available slots
                const { count: availableCount } = await supabase
                    .from('availability_slots')
                    .select('*', { count: 'exact', head: true })
                    .eq('is_available', true)
                    .gte('slot_date', today);
                
                // Get total bookings
                const { count: totalCount } = await supabase
                    .from('bookings')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('todayBookings').textContent = todayCount || 0;
                document.getElementById('pendingBookings').textContent = pendingCount || 0;
                document.getElementById('availableSlots').textContent = availableCount || 0;
                document.getElementById('totalBookings').textContent = totalCount || 0;
                
            } catch (error) {
                console.error('Error loading stats:', error);
                showAlert('Failed to load statistics', 'error');
            }
        }

        // ===== BOOKINGS MANAGEMENT =====
        async function loadBookings() {
            const filter = document.getElementById('bookingFilter').value;
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('bookingsLoading').style.display = 'flex';
            document.getElementById('bookingsTable').style.display = 'none';
            
            try {
                let query = supabase
                    .from('bookings')
                    .select('*')
                    .order('booking_date', { ascending: false })
                    .order('start_time', { ascending: false })
                    .limit(20);
                
                if (filter === 'today') {
                    query = query.eq('booking_date', today);
                } else if (filter === 'pending') {
                    query = query.eq('status', 'pending');
                } else if (filter === 'confirmed') {
                    query = query.eq('status', 'confirmed');
                }
                
                const { data: bookings, error } = await query;
                
                if (error) throw error;
                
                renderBookings(bookings);
                
                document.getElementById('bookingsLoading').style.display = 'none';
                document.getElementById('bookingsTable').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsLoading').innerHTML = '<div class="alert alert-error">Failed to load bookings</div>';
            }
        }

        function renderBookings(bookings) {
            const container = document.getElementById('bookingsList');
            container.innerHTML = '';
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--medium-gray);">
                            No bookings found
                        </td>
                    </tr>
                `;
                return;
            }
            
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const date = new Date(booking.booking_date);
                const timeString = booking.start_time ? booking.start_time.substring(0, 5) : '';
                
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${booking.customer_name || 'N/A'}</div>
                        <div style="font-size: 0.875rem; color: var(--medium-gray);">${booking.customer_email || ''}</div>
                    </td>
                    <td>${booking.service_type || 'General Service'}</td>
                    <td>
                        <div>${date.toLocaleDateString()}</div>
                        <div style="font-size: 0.875rem; color: var(--medium-gray);">${timeString}</div>
                    </td>
                    <td>
                        <span class="status-badge status-${booking.status}">${booking.status}</span>
                    </td>
                    <td>
                        <button onclick="updateBookingStatus('${booking.id}', 'confirmed')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Confirm">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="updateBookingStatus('${booking.id}', 'cancelled')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.25rem;" title="Cancel">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        async function updateBookingStatus(bookingId, status) {
            if (!confirm(`Change booking status to ${status}?`)) return;
            
            try {
                const { error } = await supabase
                    .from('bookings')
                    .update({ 
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId);
                
                if (error) throw error;
                
                loadBookings();
                loadStats();
                showAlert(`Booking status updated to ${status}`, 'success');
                
            } catch (error) {
                console.error('Error updating booking:', error);
                showAlert('Failed to update booking', 'error');
            }
        }

        // ===== AVAILABILITY MANAGEMENT =====
        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading calendar...</p></div>';
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get available dates for this month
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            try {
                const { data: availableDates, error } = await supabase
                    .from('availability_slots')
                    .select('slot_date')
                    .eq('is_available', true)
                    .gte('slot_date', startDate)
                    .lte('slot_date', endDate)
                    .lt('current_bookings', supabase.raw('max_capacity'));
                
                if (error) throw error;
                
                const availableDatesSet = new Set(availableDates.map(d => d.slot_date));
                
                calendar.innerHTML = '';
                
                // Add weekdays
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.style.textAlign = 'center';
                    dayEl.style.fontWeight = '600';
                    dayEl.style.padding = '0.5rem';
                    dayEl.textContent = day;
                    calendar.appendChild(dayEl);
                });
                
                // Add empty days
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day unavailable';
                    calendar.appendChild(emptyDay);
                }
                
                // Add month days
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dateString = date.toISOString().split('T')[0];
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;
                    dayEl.dataset.date = dateString;
                    
                    if (dateString === todayString) {
                        dayEl.classList.add('today');
                    }
                    
                    if (!availableDatesSet.has(dateString) || date < today) {
                        dayEl.classList.add('unavailable');
                    } else {
                        dayEl.addEventListener('click', () => selectDate(date));
                    }
                    
                    calendar.appendChild(dayEl);
                }
                
            } catch (error) {
                console.error('Error loading calendar:', error);
                calendar.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--medium-gray);">Failed to load calendar</div>';
            }
        }

        async function selectDate(date) {
            selectedDate = date;
            const dateString = date.toISOString().split('T')[0];
            
            // Update calendar selection
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            const selectedDay = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (selectedDay) selectedDay.classList.add('selected');
            
            // Update display
            document.getElementById('selectedDateText').textContent = 
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Load time slots
            await loadTimeSlots(dateString);
            document.getElementById('timeSlotsSection').style.display = 'block';
        }

        async function loadTimeSlots(date) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading slots...</p></div>';
            
            try {
                const { data: slots, error } = await supabase
                    .from('availability_slots')
                    .select('*')
                    .eq('slot_date', date)
                    .order('start_time', { ascending: true });
                
                if (error) throw error;
                
                if (!slots || slots.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--medium-gray); grid-column: 1 / -1;">
                            <i class="fas fa-calendar-times" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p>No time slots</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                slots.forEach(slot => {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'time-slot';
                    slotEl.dataset.slotId = slot.id;
                    
                    const startTime = slot.start_time.substring(0, 5);
                    const endTime = slot.end_time.substring(0, 5);
                    const isAvailable = slot.is_available && slot.current_bookings < slot.max_capacity;
                    
                    if (!isAvailable) {
                        slotEl.classList.add('unavailable');
                    }
                    
                    slotEl.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${startTime} - ${endTime}</div>
                        <div style="font-size: 0.75rem; color: ${isAvailable ? 'var(--primary-green)' : 'var(--red)'};">
                            ${isAvailable ? 'Available' : 'Booked'} (${slot.current_bookings}/${slot.max_capacity})
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.25rem;">
                            <button onclick="toggleSlot('${slot.id}', ${isAvailable})" 
                                    style="flex: 1; padding: 0.25rem; background: ${isAvailable ? 'var(--light-gray)' : 'var(--primary-green)'}; 
                                           color: ${isAvailable ? 'var(--dark-gray)' : 'white'}; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ${isAvailable ? 'Block' : 'Unblock'}
                            </button>
                            <button onclick="deleteSlot('${slot.id}')" 
                                    style="padding: 0.25rem 0.5rem; background: var(--red); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(slotEl);
                });
                
            } catch (error) {
                console.error('Error loading slots:', error);
                container.innerHTML = '<div class="alert alert-error">Failed to load time slots</div>';
            }
        }

        async function toggleSlot(slotId, currentlyAvailable) {
            try {
                const { error } = await supabase
                    .from('availability_slots')
                    .update({ 
                        is_available: !currentlyAvailable,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', slotId);
                
                if (error) throw error;
                
                const dateString = selectedDate.toISOString().split('T')[0];
                await loadTimeSlots(dateString);
                await renderCalendar();
                await loadStats();
                
                showAlert(`Slot ${currentlyAvailable ? 'blocked' : 'unblocked'}`, 'success');
                
            } catch (error) {
                console.error('Error toggling slot:', error);
                showAlert('Failed to update slot', 'error');
            }
        }

        async function deleteSlot(slotId) {
            if (!confirm('Delete this time slot?')) return;
            
            try {
                const { error } = await supabase
                    .from('availability_slots')
                    .delete()
                    .eq('id', slotId);
                
                if (error) throw error;
                
                const dateString = selectedDate.toISOString().split('T')[0];
                await loadTimeSlots(dateString);
                await renderCalendar();
                await loadStats();
                
                showAlert('Time slot deleted', 'success');
                
            } catch (error) {
                console.error('Error deleting slot:', error);
                showAlert('Failed to delete slot', 'error');
            }
        }

        // ===== ADD NEW TIME SLOT =====
        async function addTimeSlot(e) {
            e.preventDefault();
            
            const date = document.getElementById('slotDate').value;
            const startTime = document.getElementById('slotStartTime').value;
            const endTime = document.getElementById('slotEndTime').value;
            const capacity = document.getElementById('slotCapacity').value;
            
            try {
                // Check for existing slot[citation:1]
                const { data: existing } = await supabase
                    .from('availability_slots')
                    .select('*')
                    .eq('slot_date', date)
                    .eq('start_time', startTime + ':00')
                    .eq('end_time', endTime + ':00');
                
                if (existing && existing.length > 0) {
                    showAlert('Slot already exists at this time', 'error');
                    return;
                }
                
                // Insert new slot[citation:1]
                const { error } = await supabase
                    .from('availability_slots')
                    .insert({
                        slot_date: date,
                        start_time: startTime + ':00',
                        end_time: endTime + ':00',
                        max_capacity: parseInt(capacity),
                        current_bookings: 0,
                        is_available: true
                    });
                
                if (error) throw error;
                
                closeModal('addSlotModal');
                document.getElementById('addSlotForm').reset();
                
                // Reset defaults
                document.getElementById('slotDate').value = date;
                document.getElementById('slotStartTime').value = '09:00';
                document.getElementById('slotEndTime').value = '11:00';
                
                // Reload data
                if (date === selectedDate.toISOString().split('T')[0]) {
                    await loadTimeSlots(date);
                }
                await renderCalendar();
                await loadStats();
                
                showAlert('Time slot added', 'success');
                
            } catch (error) {
                console.error('Error adding slot:', error);
                showAlert('Failed to add time slot', 'error');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function changeMonth(delta) {
            currentMonth += delta;
            
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            renderCalendar();
            document.getElementById('timeSlotsSection').style.display = 'none';
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
            
            // Update every 30 seconds
            setTimeout(updateLastUpdated, 30000);
        }

        function showAddSlotModal() {
            document.getElementById('slotDate').value = selectedDate.toISOString().split('T')[0];
            document.getElementById('addSlotModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('alertContainer');
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function setupEventListeners() {
            document.getElementById('bookingFilter').addEventListener('change', loadBookings);
            document.getElementById('addSlotForm').addEventListener('submit', addTimeSlot);
            
            // Close modals on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal('addSlotModal');
                }
            });
            
            // Close modal on background click
            document.getElementById('addSlotModal').addEventListener('click', (e) => {
                if (e.target.id === 'addSlotModal') {
                    closeModal('addSlotModal');
                }
            });
        }
    </script>
</body>
</html>
