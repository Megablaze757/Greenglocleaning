// Replace the existing JavaScript section with this updated version:

<script>
    // ===== Supabase Configuration =====
    const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheGplbmlvaGV0ZWZxd2NzZWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU0ODU0NzEsImV4cCI6MjA1MTA2MTQ3MX0.oFmbUuS8KSHV_5OoXzkC8E4u5-d4f1V7WwZqQg5wqGU';
    
    // Create Supabase client with correct configuration
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Global State =====
    let currentBookingId = null;
    let currentView = 'dashboard';
    let bookingsData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalBookings = 0;

    // ===== DOM Elements =====
    const elements = {
        // Sections
        dashboardSection: document.getElementById('dashboardSection'),
        bookingsSection: document.getElementById('bookingsSection'),
        availabilitySection: document.getElementById('availabilitySection'),
        
        // Navigation
        navDashboard: document.getElementById('navDashboard'),
        navBookings: document.getElementById('navBookings'),
        navAvailability: document.getElementById('navAvailability'),
        
        // Stats
        totalBookings: document.getElementById('totalBookings'),
        pendingBookings: document.getElementById('pendingBookings'),
        totalRevenue: document.getElementById('totalRevenue'),
        activeCustomers: document.getElementById('activeCustomers'),
        
        // Tables
        recentBookingsBody: document.getElementById('recentBookingsBody'),
        recentLoading: document.getElementById('recentLoading'),
        recentNoData: document.getElementById('recentNoData'),
        bookingsBody: document.getElementById('bookingsBody'),
        bookingsLoading: document.getElementById('bookingsLoading'),
        bookingsNoData: document.getElementById('bookingsNoData'),
        bookingsPagination: document.getElementById('bookingsPagination'),
        
        // Search & Filters
        bookingSearch: document.getElementById('bookingSearch'),
        statusFilter: document.getElementById('statusFilter'),
        dateFilter: document.getElementById('dateFilter'),
        recentFilter: document.getElementById('recentFilter'),
        
        // Modals
        bookingDetailsModal: document.getElementById('bookingDetailsModal'),
        editBookingModal: document.getElementById('editBookingModal'),
        newBookingModal: document.getElementById('newBookingModal'),
        confirmModal: document.getElementById('confirmModal'),
        
        // Buttons
        refreshBtn: document.getElementById('refreshBtn'),
        newBookingBtn: document.getElementById('newBookingBtn'),
        mobileMenuToggle: document.getElementById('mobileMenuToggle'),
        sidebar: document.getElementById('sidebar')
    };

    // ===== Initialize Admin Panel =====
    document.addEventListener('DOMContentLoaded', function() {
        initAdminPanel();
        setupEventListeners();
        loadDashboardData();
        
        // Set current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-GB', options);
        
        // Set default date in forms to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('newDate').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('editDate').value = tomorrow.toISOString().split('T')[0];
    });

    function initAdminPanel() {
        // Check if user is authenticated (simple check for demo)
        const isAuthenticated = localStorage.getItem('greenglo_admin_auth') === 'authenticated';
        
        if (!isAuthenticated) {
            // Show login modal
            showLoginModal();
        } else {
            setupNavigation();
        }
    }

    function showLoginModal() {
        // Create login modal
        const loginModal = document.createElement('div');
        loginModal.className = 'modal-overlay active';
        loginModal.style.zIndex = '9999';
        loginModal.innerHTML = `
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>Admin Login</h3>
                </div>
                <div class="modal-content">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="adminPassword">Admin Password</label>
                            <input type="password" id="adminPassword" placeholder="Enter admin password" required>
                            <p style="font-size: 0.875rem; color: var(--medium-gray); margin-top: 0.5rem;">
                                Default password: admin123
                            </p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="loginBtn">Login</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(loginModal);
        
        // Add login functionality
        document.getElementById('loginBtn').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            
            // Simple password check (in production, use proper authentication)
            if (password === 'admin123') {
                localStorage.setItem('greenglo_admin_auth', 'authenticated');
                loginModal.remove();
                showNotification('Login successful!', 'Welcome to GreenGlo Admin Panel');
                setupNavigation();
                loadDashboardData();
            } else {
                alert('Incorrect password. Try: admin123');
            }
        });
    }

    function setupNavigation() {
        // Navigation click handlers
        elements.navDashboard.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('dashboard');
        });
        
        elements.navBookings.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('bookings');
        });
        
        elements.navAvailability.addEventListener('click', function(e) {
            e.preventDefault();
            switchView('availability');
        });
        
        // Mobile menu toggle
        elements.mobileMenuToggle.addEventListener('click', function() {
            elements.sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 1200) {
                if (!elements.sidebar.contains(e.target) && 
                    !elements.mobileMenuToggle.contains(e.target) &&
                    elements.sidebar.classList.contains('active')) {
                    elements.sidebar.classList.remove('active');
                }
            }
        });
    }

    function switchView(view) {
        // Hide all sections
        elements.dashboardSection.style.display = 'none';
        elements.bookingsSection.style.display = 'none';
        elements.availabilitySection.style.display = 'none';
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.classList.remove('active');
        });
        
        // Show selected section and update active nav
        currentView = view;
        switch(view) {
            case 'dashboard':
                elements.dashboardSection.style.display = 'block';
                elements.navDashboard.classList.add('active');
                loadDashboardData();
                break;
            case 'bookings':
                elements.bookingsSection.style.display = 'block';
                elements.navBookings.classList.add('active');
                loadBookings();
                break;
            case 'availability':
                elements.availabilitySection.style.display = 'block';
                elements.navAvailability.classList.add('active');
                loadAvailabilityCalendar();
                break;
        }
        
        // Close mobile sidebar
        if (window.innerWidth <= 1200) {
            elements.sidebar.classList.remove('active');
        }
    }

    function setupEventListeners() {
        // Refresh button
        elements.refreshBtn.addEventListener('click', function() {
            refreshCurrentView();
        });
        
        // New booking button
        elements.newBookingBtn.addEventListener('click', function() {
            showNewBookingModal();
        });
        
        // Search and filter events
        elements.bookingSearch.addEventListener('input', function() {
            debounceSearch();
        });
        
        elements.statusFilter.addEventListener('change', function() {
            loadBookings();
        });
        
        elements.dateFilter.addEventListener('change', function() {
            loadBookings();
        });
        
        elements.recentFilter.addEventListener('change', function() {
            loadRecentBookings();
        });
        
        // Modal close buttons
        document.getElementById('closeDetailsModal').addEventListener('click', closeBookingDetails);
        document.getElementById('closeEditModal').addEventListener('click', closeEditBooking);
        document.getElementById('closeNewModal').addEventListener('click', closeNewBooking);
        document.getElementById('closeConfirmModal').addEventListener('click', closeConfirmModal);
        
        // Modal cancel buttons
        document.getElementById('closeDetailsBtn').addEventListener('click', closeBookingDetails);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditBooking);
        document.getElementById('cancelNewBtn').addEventListener('click', closeNewBooking);
        document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);
        
        // Save/edit booking buttons
        document.getElementById('saveBookingBtn').addEventListener('click', saveBookingChanges);
        document.getElementById('createBookingBtn').addEventListener('click', createNewBooking);
        
        // Edit booking button in details modal
        document.getElementById('editBookingBtn').addEventListener('click', function() {
            closeBookingDetails();
            showEditBookingModal(currentBookingId);
        });
        
        // Cancel booking button
        document.getElementById('cancelBookingBtn').addEventListener('click', function() {
            showCancelBookingConfirmation(currentBookingId);
        });
        
        // Confirm action button
        document.getElementById('confirmActionBtn').addEventListener('click', confirmAction);
        
        // Price calculation when service/duration changes
        document.getElementById('newServiceType').addEventListener('change', calculatePrice);
        document.getElementById('newDuration').addEventListener('change', calculatePrice);
        document.getElementById('editServiceType').addEventListener('change', calculateEditPrice);
        document.getElementById('editDuration').addEventListener('change', calculateEditPrice);
    }

    // ===== Data Loading Functions =====
    async function loadDashboardData() {
        try {
            // Load stats
            await loadDashboardStats();
            
            // Load recent bookings
            await loadRecentBookings();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showNotification('Error loading dashboard data', 'error');
        }
    }

    async function loadDashboardStats() {
        try {
            // Get today's date range
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // Get this week's date range
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndStr = weekEnd.toISOString().split('T')[0];
            
            // Query for all bookings
            const { data: allBookings, error: allError } = await supabase
                .from('bookings')
                .select('*');
            
            if (allError) throw allError;
            
            // Query for pending bookings
            const { data: pendingBookings, error: pendingError } = await supabase
                .from('bookings')
                .select('*')
                .eq('status', 'pending');
            
            if (pendingError) throw pendingError;
            
            // Query for today's bookings
            const { data: todayBookings, error: todayError } = await supabase
                .from('bookings')
                .select('*')
                .eq('date', todayStr);
            
            if (todayError) throw todayError;
            
            // Query for this week's bookings
            const { data: weekBookings, error: weekError } = await supabase
                .from('bookings')
                .select('*')
                .gte('date', weekStartStr)
                .lt('date', weekEndStr);
            
            if (weekError) throw weekError;
            
            // Calculate total revenue
            const totalRevenue = allBookings.reduce((sum, booking) => {
                return sum + (parseFloat(booking.total_price) || 0);
            }, 0);
            
            // Calculate week revenue
            const weekRevenue = weekBookings.reduce((sum, booking) => {
                return sum + (parseFloat(booking.total_price) || 0);
            }, 0);
            
            // Get unique customers
            const uniqueCustomers = [...new Set(allBookings.map(b => b.phone))].length;
            
            // Update UI
            elements.totalBookings.textContent = allBookings.length;
            elements.pendingBookings.textContent = pendingBookings.length;
            elements.totalRevenue.textContent = `£${totalRevenue.toFixed(2)}`;
            elements.activeCustomers.textContent = uniqueCustomers;
            
            // Update sidebar stats
            document.getElementById('statToday').textContent = todayBookings.length;
            document.getElementById('statWeek').textContent = weekBookings.length;
            document.getElementById('statRevenue').textContent = `£${weekRevenue.toFixed(2)}`;
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
            showNotification('Error loading statistics', 'error');
        }
    }

    async function loadRecentBookings() {
        try {
            elements.recentLoading.style.display = 'flex';
            elements.recentNoData.style.display = 'none';
            
            const days = parseInt(elements.recentFilter.value);
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - days);
            
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .gte('created_at', dateLimit.toISOString())
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (error) throw error;
            
            elements.recentLoading.style.display = 'none';
            
            if (!bookings || bookings.length === 0) {
                elements.recentNoData.style.display = 'block';
                return;
            }
            
            // Clear table
            elements.recentBookingsBody.innerHTML = '';
            
            // Populate table
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${booking.id}</strong></td>
                    <td>${formatDate(booking.date)}<br><small>${booking.time}</small></td>
                    <td>${booking.name}<br><small>${booking.phone}</small></td>
                    <td>${getServiceName(booking.service_type)}</td>
                    <td>£${parseFloat(booking.total_price).toFixed(2)}</td>
                    <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="showBookingDetails('${booking.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditBookingModal('${booking.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.recentBookingsBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading recent bookings:', error);
            elements.recentLoading.style.display = 'none';
            showNotification('Error loading recent bookings', 'error');
        }
    }

    async function loadBookings(page = 1) {
        try {
            currentPage = page;
            elements.bookingsLoading.style.display = 'flex';
            elements.bookingsNoData.style.display = 'none';
            
            // Build query
            let query = supabase.from('bookings').select('*', { count: 'exact' });
            
            // Apply search filter
            const searchTerm = elements.bookingSearch.value.trim();
            if (searchTerm) {
                query = query.or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,id.ilike.%${searchTerm}%`);
            }
            
            // Apply status filter
            const status = elements.statusFilter.value;
            if (status !== 'all') {
                query = query.eq('status', status);
            }
            
            // Apply date filter
            const dateFilter = elements.dateFilter.value;
            if (dateFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                let startDate, endDate;
                
                switch(dateFilter) {
                    case 'today':
                        query = query.eq('date', todayStr);
                        break;
                    case 'week':
                        const weekStart = new Date(today);
                        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                        const weekStartStr = weekStart.toISOString().split('T')[0];
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 7);
                        const weekEndStr = weekEnd.toISOString().split('T')[0];
                        query = query.gte('date', weekStartStr).lt('date', weekEndStr);
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthStartStr = monthStart.toISOString().split('T')[0];
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                        const monthEndStr = monthEnd.toISOString().split('T')[0];
                        query = query.gte('date', monthStartStr).lt('date', monthEndStr);
                        break;
                }
            }
            
            // Apply pagination
            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;
            
            query = query.order('date', { ascending: false })
                        .order('time', { ascending: true })
                        .range(from, to);
            
            const { data: bookings, error, count } = await query;
            
            if (error) throw error;
            
            elements.bookingsLoading.style.display = 'none';
            bookingsData = bookings || [];
            totalBookings = count || 0;
            
            if (!bookings || bookings.length === 0) {
                elements.bookingsNoData.style.display = 'block';
                elements.bookingsPagination.innerHTML = '';
                return;
            }
            
            // Clear table
            elements.bookingsBody.innerHTML = '';
            
            // Populate table
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${booking.id}</strong></td>
                    <td>${formatDate(booking.date)}</td>
                    <td>${booking.time}</td>
                    <td>
                        ${booking.name}<br>
                        <small style="color: var(--medium-gray);">${booking.phone}</small>
                    </td>
                    <td>${getServiceName(booking.service_type)}</td>
                    <td>${booking.duration} hours</td>
                    <td>£${parseFloat(booking.total_price).toFixed(2)}</td>
                    <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="showBookingDetails('${booking.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditBookingModal('${booking.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="showDeleteConfirmation('${booking.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.bookingsBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination();
            
        } catch (error) {
            console.error('Error loading bookings:', error);
            elements.bookingsLoading.style.display = 'none';
            showNotification('Error loading bookings', 'error');
        }
    }

    function updatePagination() {
        const totalPages = Math.ceil(totalBookings / itemsPerPage);
        
        if (totalPages <= 1) {
            elements.bookingsPagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <button class="page-btn" onclick="loadBookings(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadBookings(${i})">
                    ${i}
                </button>
            `;
        }
        
        // Next button
        paginationHTML += `
            <button class="page-btn" onclick="loadBookings(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
        
        elements.bookingsPagination.innerHTML = paginationHTML;
    }

    async function loadAvailabilityCalendar() {
        try {
            // Load next 30 days of availability
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 30);
            const todayStr = today.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            // First, get all bookings for the next 30 days
            const { data: bookings, error: bookingsError } = await supabase
                .from('bookings')
                .select('date, time')
                .gte('date', todayStr)
                .lte('date', endDateStr)
                .neq('status', 'cancelled');
            
            if (bookingsError) throw bookingsError;
            
            // Create a Set of booked time slots
            const bookedSlots = new Set();
            bookings.forEach(booking => {
                bookedSlots.add(`${booking.date}_${booking.time}`);
            });
            
            // Generate time slots for next 30 days
            const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
            
            // Generate calendar HTML
            let calendarHTML = '<div class="availability-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">';
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                
                // Count available slots for this day
                let availableSlots = 0;
                const slotHTML = timeSlots.map(time => {
                    const isBooked = bookedSlots.has(`${dateString}_${time}`);
                    const available = !isBooked;
                    if (available) availableSlots++;
                    
                    return `
                        <button onclick="toggleSlotAvailability('${dateString}', '${time}', ${available})" 
                                style="padding: 0.5rem; border-radius: 8px; border: none; background: ${available ? 'var(--light-green)' : 'var(--light-gray)'}; color: ${available ? 'var(--dark-green)' : 'var(--dark-gray)'}; cursor: pointer; font-size: 0.875rem; min-width: 70px;">
                            ${time}<br>
                            <small>${available ? 'Available' : 'Booked'}</small>
                        </button>
                    `;
                }).join('');
                
                calendarHTML += `
                    <div style="background: var(--white); border: 2px solid ${availableSlots > 0 ? 'var(--secondary-green)' : 'var(--light-gray)'}; border-radius: var(--border-radius); padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <strong>${formatDate(dateString)}</strong><br>
                                <small style="color: var(--medium-gray);">${date.toLocaleDateString('en-GB', { weekday: 'long' })}</small>
                            </div>
                            <span class="status-badge ${availableSlots > 0 ? 'status-confirmed' : 'status-cancelled'}">
                                ${availableSlots}/${timeSlots.length} slots
                            </span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${slotHTML}
                        </div>
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            
            document.getElementById('availabilityCalendar').innerHTML = calendarHTML;
            
        } catch (error) {
            console.error('Error loading availability:', error);
            showNotification('Error loading availability calendar', 'error');
        }
    }

    // ===== Modal Functions =====
    async function showBookingDetails(bookingId) {
        try {
            currentBookingId = bookingId;
            
            // Find booking from Supabase
            const { data: booking, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('id', bookingId)
                .single();
            
            if (error) throw error;
            
            if (!booking) {
                showNotification('Booking not found', 'error');
                return;
            }
            
            // Populate details
            const detailsHTML = `
                <div class="detail-row">
                    <span class="detail-label">Booking ID:</span>
                    <span class="detail-value">${booking.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date & Time:</span>
                    <span class="detail-value">${formatDate(booking.date)} at ${booking.time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span class="detail-value">${booking.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${booking.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${booking.email || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Address:</span>
                    <span class="detail-value">${booking.address}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Service:</span>
                    <span class="detail-value">${getServiceName(booking.service_type)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">${booking.duration} hours</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value badge status-${booking.status}">${booking.status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Price:</span>
                    <span class="detail-value">£${parseFloat(booking.total_price).toFixed(2)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Special Instructions:</span>
                    <span class="detail-value">${booking.special_instructions || 'None'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value">${formatDateTime(booking.created_at)}</span>
                </div>
            `;
            
            document.getElementById('bookingDetailsContent').innerHTML = detailsHTML;
            elements.bookingDetailsModal.classList.add('active');
            
        } catch (error) {
            console.error('Error loading booking details:', error);
            showNotification('Error loading booking details', 'error');
        }
    }

    function closeBookingDetails() {
        elements.bookingDetailsModal.classList.remove('active');
        currentBookingId = null;
    }

    async function showEditBookingModal(bookingId) {
        try {
            currentBookingId = bookingId;
            
            // Find booking from Supabase
            const { data: booking, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('id', bookingId)
                .single();
            
            if (error) throw error;
            
            if (!booking) {
                showNotification('Booking not found', 'error');
                return;
            }
            
            // Populate form
            document.getElementById('editDate').value = booking.date;
            document.getElementById('editTime').value = booking.time;
            document.getElementById('editServiceType').value = booking.service_type;
            document.getElementById('editDuration').value = booking.duration;
            document.getElementById('editCustomerName').value = booking.name;
            document.getElementById('editCustomerPhone').value = booking.phone;
            document.getElementById('editCustomerEmail').value = booking.email || '';
            document.getElementById('editStatus').value = booking.status;
            document.getElementById('editAddress').value = booking.address;
            document.getElementById('editInstructions').value = booking.special_instructions || '';
            document.getElementById('editPrice').value = booking.total_price;
            document.getElementById('editAmountPaid').value = booking.amount_paid || '0';
            
            elements.editBookingModal.classList.add('active');
            
        } catch (error) {
            console.error('Error loading booking for edit:', error);
            showNotification('Error loading booking', 'error');
        }
    }

    function closeEditBooking() {
        elements.editBookingModal.classList.remove('active');
        currentBookingId = null;
    }

    function showNewBookingModal() {
        // Set default values
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('newDate').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('newTime').value = '09:00';
        document.getElementById('newServiceType').value = 'regular';
        document.getElementById('newDuration').value = '3';
        document.getElementById('newCustomerName').value = '';
        document.getElementById('newCustomerPhone').value = '';
        document.getElementById('newCustomerEmail').value = '';
        document.getElementById('newStatus').value = 'confirmed';
        document.getElementById('newAddress').value = '';
        document.getElementById('newInstructions').value = '';
        
        // Calculate initial price
        calculatePrice();
        
        elements.newBookingModal.classList.add('active');
    }

    function closeNewBooking() {
        elements.newBookingModal.classList.remove('active');
    }

    function showCancelBookingConfirmation(bookingId) {
        currentBookingId = bookingId;
        document.getElementById('confirmMessage').textContent = `Are you sure you want to cancel booking ${bookingId}?`;
        document.getElementById('confirmActionBtn').textContent = 'Cancel Booking';
        document.getElementById('confirmActionBtn').onclick = function() {
            cancelBooking(bookingId);
        };
        elements.confirmModal.classList.add('active');
    }

    function showDeleteConfirmation(bookingId) {
        currentBookingId = bookingId;
        document.getElementById('confirmMessage').textContent = `Are you sure you want to delete booking ${bookingId}? This action cannot be undone.`;
        document.getElementById('confirmActionBtn').textContent = 'Delete Booking';
        document.getElementById('confirmActionBtn').onclick = function() {
            deleteBooking(bookingId);
        };
        elements.confirmModal.classList.add('active');
    }

    function closeConfirmModal() {
        elements.confirmModal.classList.remove('active');
        currentBookingId = null;
    }

    function confirmAction() {
        // This is handled by the specific confirmation modals
        closeConfirmModal();
    }

    // ===== CRUD Operations =====
    async function saveBookingChanges() {
        try {
            const bookingId = currentBookingId;
            
            const updatedData = {
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                service_type: document.getElementById('editServiceType').value,
                duration: parseInt(document.getElementById('editDuration').value),
                name: document.getElementById('editCustomerName').value,
                phone: document.getElementById('editCustomerPhone').value,
                email: document.getElementById('editCustomerEmail').value,
                status: document.getElementById('editStatus').value,
                address: document.getElementById('editAddress').value,
                special_instructions: document.getElementById('editInstructions').value,
                total_price: parseFloat(document.getElementById('editPrice').value),
                amount_paid: parseFloat(document.getElementById('editAmountPaid').value) || 0,
                updated_at: new Date().toISOString()
            };
            
            // Validate required fields
            if (!updatedData.date || !updatedData.time || !updatedData.name || !updatedData.phone || !updatedData.address) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Update booking in Supabase
            const { error } = await supabase
                .from('bookings')
                .update(updatedData)
                .eq('id', bookingId);
            
            if (error) throw error;
            
            closeEditBooking();
            showNotification('Booking updated successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error updating booking:', error);
            showNotification('Error updating booking', 'error');
        }
    }

    async function createNewBooking() {
        try {
            const bookingData = {
                id: 'GG-' + Date.now().toString().slice(-6),
                date: document.getElementById('newDate').value,
                time: document.getElementById('newTime').value,
                service_type: document.getElementById('newServiceType').value,
                duration: parseInt(document.getElementById('newDuration').value),
                name: document.getElementById('newCustomerName').value,
                phone: document.getElementById('newCustomerPhone').value,
                email: document.getElementById('newCustomerEmail').value,
                status: document.getElementById('newStatus').value,
                address: document.getElementById('newAddress').value,
                special_instructions: document.getElementById('newInstructions').value,
                total_price: parseFloat(document.getElementById('newPrice').value),
                amount_paid: parseFloat(document.getElementById('newAmountPaid').value) || 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // Validate required fields
            if (!bookingData.date || !bookingData.time || !bookingData.name || !bookingData.phone || !bookingData.address) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Check if slot is already booked
            const { data: existingBooking, error: checkError } = await supabase
                .from('bookings')
                .select('*')
                .eq('date', bookingData.date)
                .eq('time', bookingData.time)
                .neq('status', 'cancelled')
                .single();
            
            if (existingBooking && !checkError) {
                showNotification('Selected time slot is already booked', 'error');
                return;
            }
            
            // Create booking in Supabase
            const { error: bookingError } = await supabase
                .from('bookings')
                .insert([bookingData]);
            
            if (bookingError) throw bookingError;
            
            closeNewBooking();
            showNotification('Booking created successfully!');
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error creating booking:', error);
            showNotification('Error creating booking', 'error');
        }
    }

    async function cancelBooking(bookingId) {
        try {
            // Update booking status
            const { error } = await supabase
                .from('bookings')
                .update({ 
                    status: 'cancelled',
                    updated_at: new Date().toISOString()
                })
                .eq('id', bookingId);
            
            if (error) throw error;
            
            showNotification('Booking cancelled successfully!');
            closeConfirmModal();
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error cancelling booking:', error);
            showNotification('Error cancelling booking', 'error');
        }
    }

    async function deleteBooking(bookingId) {
        try {
            // Delete booking
            const { error } = await supabase
                .from('bookings')
                .delete()
                .eq('id', bookingId);
            
            if (error) throw error;
            
            showNotification('Booking deleted successfully!');
            closeConfirmModal();
            refreshCurrentView();
            
        } catch (error) {
            console.error('Error deleting booking:', error);
            showNotification('Error deleting booking', 'error');
        }
    }

    async function toggleSlotAvailability(date, time, currentAvailability) {
        try {
            // For now, we'll block slots by creating a dummy booking
            if (currentAvailability) {
                // Block the slot by creating a cancelled booking
                const dummyBooking = {
                    id: 'BLOCKED-' + Date.now().toString().slice(-6),
                    date: date,
                    time: time,
                    service_type: 'regular',
                    duration: 2,
                    name: 'Admin Blocked',
                    phone: '00000000000',
                    email: '',
                    status: 'cancelled',
                    address: 'Slot Blocked',
                    special_instructions: 'Admin blocked this time slot',
                    total_price: 0,
                    amount_paid: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('bookings')
                    .insert([dummyBooking]);
                
                if (error) throw error;
                
                showNotification('Slot blocked successfully!');
            } else {
                // Unblock by deleting any blocked bookings for this slot
                const { error } = await supabase
                    .from('bookings')
                    .delete()
                    .eq('date', date)
                    .eq('time', time)
                    .eq('name', 'Admin Blocked');
                
                if (error) throw error;
                
                showNotification('Slot opened successfully!');
            }
            
            loadAvailabilityCalendar();
            
        } catch (error) {
            console.error('Error toggling slot availability:', error);
            showNotification('Error updating slot', 'error');
        }
    }

    // ===== Utility Functions =====
    function refreshCurrentView() {
        switch(currentView) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'bookings':
                loadBookings(currentPage);
                break;
            case 'availability':
                loadAvailabilityCalendar();
                break;
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function getServiceName(serviceType) {
        const services = {
            'regular': 'Regular Cleaning',
            'deep': 'Deep Cleaning',
            'end_tenancy': 'End of Tenancy',
            'carpet': 'Carpet Cleaning',
            'oven': 'Oven Cleaning',
            'office': 'Office Cleaning'
        };
        return services[serviceType] || serviceType;
    }

    function calculatePrice() {
        const serviceType = document.getElementById('newServiceType').value;
        const duration = parseInt(document.getElementById('newDuration').value);
        let price = 0;
        
        switch(serviceType) {
            case 'regular':
                price = duration * 18;
                break;
            case 'deep':
                price = duration * 25;
                break;
            case 'end_tenancy':
                price = duration * 30;
                break;
            case 'carpet':
                price = duration * 25; // Per room estimate
                break;
            case 'oven':
                price = 45; // Fixed price
                break;
            case 'office':
                price = duration * 25; // Per m² estimate
                break;
        }
        
        document.getElementById('newPrice').value = price.toFixed(2);
        document.getElementById('newAmountPaid').value = '0';
    }

    function calculateEditPrice() {
        const serviceType = document.getElementById('editServiceType').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        let price = 0;
        
        switch(serviceType) {
            case 'regular':
                price = duration * 18;
                break;
            case 'deep':
                price = duration * 25;
                break;
            case 'end_tenancy':
                price = duration * 30;
                break;
            case 'carpet':
                price = duration * 25;
                break;
            case 'oven':
                price = 45;
                break;
            case 'office':
                price = duration * 25;
                break;
        }
        
        document.getElementById('editPrice').value = price.toFixed(2);
    }

    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        const title = document.getElementById('notificationTitle');
        const msg = document.getElementById('notificationMessage');
        
        // Set colors based on type
        let borderColor = 'var(--primary-green)';
        if (type === 'error') {
            borderColor = 'var(--red)';
            title.textContent = 'Error';
        } else if (type === 'warning') {
            borderColor = 'var(--orange)';
            title.textContent = 'Warning';
        } else if (type === 'info') {
            borderColor = 'var(--blue)';
            title.textContent = 'Info';
        } else {
            title.textContent = 'Success';
        }
        
        toast.style.borderLeftColor = borderColor;
        msg.textContent = message;
        
        toast.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(hideNotification, 5000);
    }

    function hideNotification() {
        document.getElementById('notificationToast').style.display = 'none';
    }

    // Debounce search
    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadBookings(1);
        }, 500);
    }

    // Export data function
    async function exportBookings(format = 'csv') {
        try {
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*');
            
            if (error) throw error;
            
            if (format === 'csv') {
                // Convert to CSV
                const headers = ['ID', 'Date', 'Time', 'Customer', 'Phone', 'Email', 'Address', 'Service', 'Duration', 'Price', 'Status', 'Created'];
                const csvData = bookings.map(booking => [
                    booking.id,
                    booking.date,
                    booking.time,
                    booking.name,
                    booking.phone,
                    booking.email || '',
                    booking.address,
                    getServiceName(booking.service_type),
                    booking.duration,
                    booking.total_price,
                    booking.status,
                    new Date(booking.created_at).toLocaleDateString()
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...csvData.map(row => row.join(','))
                ].join('\n');
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `greenglo-bookings-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
            
            showNotification('Data exported successfully!');
            
        } catch (error) {
            console.error('Error exporting data:', error);
            showNotification('Error exporting data', 'error');
        }
    }

    // Add export button to header
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn btn-small btn-outline';
    exportBtn.innerHTML = '<i class="fas fa-download"></i> Export';
    exportBtn.onclick = () => exportBookings('csv');
    elements.adminActions.insertBefore(exportBtn, elements.newBookingBtn);

    // ===== Initial Load =====
    // Load dashboard by default if authenticated
    if (localStorage.getItem('greenglo_admin_auth') === 'authenticated') {
        switchView('dashboard');
    }
</script>
