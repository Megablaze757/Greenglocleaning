<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>GreenGlo Admin | Availability Management</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-green: #10B981;
            --secondary-green: #34D399;
            --dark-green: #065F46;
            --light-green: #D1FAE5;
            --accent-green: #059669;
            --white: #FFFFFF;
            --off-white: #F9FAFB;
            --light-gray: #F3F4F6;
            --medium-gray: #9CA3AF;
            --dark-gray: #4B5563;
            --black: #111827;
            --red: #EF4444;
            --orange: #F59E0B;
            --blue: #3B82F6;
            --shadow: 0 10px 25px rgba(16, 185, 129, 0.12);
            --shadow-lg: 0 20px 40px rgba(16, 185, 129, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 16px;
            --gradient-primary: linear-gradient(135deg, var(--primary-green), #0D9488);
            --gradient-dark: linear-gradient(135deg, var(--dark-green), #0D9488);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.7;
            color: var(--dark-gray);
            background-color: var(--off-white);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-header {
            background: var(--gradient-dark);
            color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .admin-logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .admin-logo-text h1 {
            color: var(--white);
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .admin-logo-text span {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .last-updated {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(16, 185, 129, 0.1);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: var(--blue);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .stat-icon.orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-green);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--medium-gray);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            color: var(--dark-green);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-header h2 i {
            color: var(--primary-green);
        }

        /* Calendar Management */
        .calendar-management {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .calendar-header {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-header h3 {
            color: var(--white);
            font-size: 1.25rem;
            margin: 0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--white);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .current-month {
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .calendar-grid {
            padding: 2rem;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: var(--white);
            display: flex;
            flex-direction: column;
            min-height: 80px;
        }

        .calendar-day:hover:not(.past):not(.empty) {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .calendar-day.past {
            opacity: 0.7;
            cursor: not-allowed;
            background: var(--off-white);
        }

        .calendar-day.past .day-number {
            color: var(--medium-gray);
        }

        .calendar-day.empty {
            cursor: default;
            border: none;
            background: transparent;
        }

        .calendar-day.today {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .calendar-day.selected {
            border-color: var(--primary-green);
            background: var(--gradient-primary);
            color: var(--white);
        }

        .calendar-day.selected .day-number {
            color: var(--white);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .day-status {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            display: inline-block;
            font-weight: 600;
            margin-top: auto;
            align-self: flex-start;
        }

        .status-available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .status-partial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .status-blocked {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Time Slot Management */
        .time-slot-management {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .time-slot-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .time-slot-header h3 {
            color: var(--dark-green);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .time-slot-header p {
            color: var(--medium-gray);
            font-size: 0.875rem;
        }

        .time-slots-container {
            padding: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .time-slot-item {
            padding: 1rem;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
        }

        .time-slot-item:hover {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .time-slot-item.available {
            border-color: var(--primary-green);
            background: var(--light-green);
        }

        .time-slot-item.blocked {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.05);
        }

        .time-slot-time {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .time-slot-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            display: inline-block;
            font-weight: 600;
        }

        .time-slot-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-green);
            color: var(--primary-green);
        }

        .btn-outline:hover {
            background: var(--primary-green);
            color: var(--white);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
            border: 2px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Bookings Table */
        .bookings-table {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .table-header h3 {
            color: var(--dark-green);
            font-size: 1.25rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--off-white);
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        td {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--light-gray);
        }

        tbody tr:hover {
            background: var(--off-white);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            gap: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .time-slots-grid {
                grid-template-columns: 1fr;
            }

            .calendar-header {
                flex-direction: column;
                gap: 1rem;
            }

            table {
                font-size: 0.875rem;
            }

            th,
            td {
                padding: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="admin-logo">
                <div class="admin-logo-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="admin-logo-text">
                    <h1>GreenGlo Admin Panel</h1>
                    <span>Manage availability and view bookings</span>
                </div>
            </div>
            <div class="last-updated">
                <i class="fas fa-sync-alt"></i>
                <span id="lastUpdatedTime">Loading...</span>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="section-header">
            <h2><i class="fas fa-chart-line"></i> Dashboard Overview</h2>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalBookings">0</div>
                <div class="stat-label">Total Bookings</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="confirmedBookings">0</div>
                <div class="stat-label">Confirmed Bookings</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-value" id="upcomingBookings">0</div>
                <div class="stat-label">Upcoming This Week</div>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="section-header">
            <h2><i class="fas fa-list"></i> All Bookings</h2>
        </div>

        <div class="bookings-table">
            <div class="table-header">
                <h3>Customer Bookings</h3>
            </div>
            <div id="bookingsContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading bookings...</p>
                </div>
            </div>
        </div>

        <!-- Availability Management -->
        <div class="section-header">
            <h2><i class="fas fa-calendar-alt"></i> Manage Availability</h2>
        </div>

        <div class="calendar-management">
            <div class="calendar-header">
                <h3>Select Date</h3>
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="calendar-nav-btn" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="calendar-grid">
                <div class="weekdays">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
        </div>

        <div class="time-slot-management">
            <div class="time-slot-header">
                <h3>Time Slots for <span id="selectedDateDisplay">Select a date</span></h3>
                <p>Click on time slots to toggle availability</p>
            </div>

            <div class="time-slots-container">
                <div class="time-slots-grid" id="timeSlotsGrid">
                    <p style="text-align: center; color: var(--medium-gray); padding: 2rem;">Select a date from the calendar above to manage time slots</p>
                </div>
            </div>

            <div class="time-slot-actions" id="timeSlotActions">
                <button class="btn btn-primary" id="saveAvailability">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
                <button class="btn btn-outline" id="markAllAvailable">
                    <i class="fas fa-check-square"></i>
                    Mark All Available
                </button>
                <button class="btn btn-danger" id="blockAllSlots">
                    <i class="fas fa-ban"></i>
                    Block All Slots
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://faxjeniohetefqwcsefi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheGplbmlvaGV0ZWZxd2NzZWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzOTQ2MzcsImV4cCI6MjA1MDk3MDYzN30.tOKrAcF3SB2qlBPOx32G-QDf3mTe3yR-Y4qr6-5pN7M';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global Variables
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let currentTimeSlots = [];

        // Time slot template
        const TIME_SLOTS = [
            '08:00-10:00',
            '10:00-12:00',
            '12:00-14:00',
            '14:00-16:00',
            '16:00-18:00',
            '18:00-20:00'
        ];

        // Helper function to format date as YYYY-MM-DD
        function formatDateToYMD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Update last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('lastUpdatedTime').textContent = 
                `Last updated: ${now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
        }

        // Load Stats
        async function loadStats() {
            try {
                const { data: bookings, error } = await supabase
                    .from('bookings')
                    .select('*');

                if (error) throw error;

                const total = bookings?.length || 0;
                const confirmed = bookings?.filter(b => b.status === 'confirmed').length || 0;
                
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);
                
                const upcoming = bookings?.filter(b => {
                    const bookingDate = new Date(b.date);
                    return bookingDate >= today && bookingDate <= nextWeek;
                }).length || 0;

                document.getElementById('totalBookings').textContent = total;
                document.getElementById('confirmedBookings').textContent = confirmed;
                document.getElementById('upcomingBookings').textContent = upcoming;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load All Bookings
        async function loadBookings() {
            try {
                const { data: bookings, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;

                displayBookingsTable(bookings);
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsContainer').innerHTML = 
                    '<p style="padding: 2rem; text-align: center; color: var(--medium-gray);">Error loading bookings</p>';
            }
        }

        function displayBookingsTable(bookings) {
            const container = document.getElementById('bookingsContainer');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--medium-gray);">No bookings found</p>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date</th>
                            <th>Time Slot</th>
                            <th>Service</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(booking => `
                            <tr>
                                <td>${booking.name || 'N/A'}</td>
                                <td>${booking.email || 'N/A'}</td>
                                <td>${booking.phone || 'N/A'}</td>
                                <td>${formatDateDisplay(booking.date)}</td>
                                <td>${booking.time_slot || 'N/A'}</td>
                                <td>${booking.service || 'N/A'}</td>
                                <td>
                                    <span class="badge ${getStatusClass(booking.status)}">
                                        ${booking.status || 'pending'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function getStatusClass(status) {
            switch(status?.toLowerCase()) {
                case 'confirmed': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'cancelled': return 'badge-danger';
                default: return 'badge-warning';
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            document.getElementById('currentMonth').textContent = 
                firstDay.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

            // Add empty cells for days before first day of month
            const firstDayIndex = firstDay.getDay();
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarDays.appendChild(emptyDay);
            }

            // Add days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dateString = formatDateToYMD(date);
                dayElement.dataset.date = dateString;

                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                if (date < today) {
                    dayElement.classList.add('past');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                if (date >= today) {
                    dayElement.addEventListener('click', () => selectDateForAvailability(date));
                }

                calendarDays.appendChild(dayElement);
            }

            loadCalendarAvailability();
        }

        async function loadCalendarAvailability() {
            try {
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);

                const firstDayStr = formatDateToYMD(firstDay);
                const lastDayStr = formatDateToYMD(lastDay);

                const { data: availability, error } = await supabase
                    .from('availability')
                    .select('*')
                    .gte('date', firstDayStr)
                    .lte('date', lastDayStr);

                if (error) throw error;

                const dateAvailability = {};
                availability?.forEach(slot => {
                    if (!dateAvailability[slot.date]) {
                        dateAvailability[slot.date] = { available: 0, blocked: 0 };
                    }
                    if (slot.is_available) {
                        dateAvailability[slot.date].available++;
                    } else {
                        dateAvailability[slot.date].blocked++;
                    }
                });

                Object.keys(dateAvailability).forEach(date => {
                    const dayElement = document.querySelector(`[data-date="${date}"]`);
                    if (dayElement && !dayElement.classList.contains('past')) {
                        const stats = dateAvailability[date];
                        const statusBadge = document.createElement('div');
                        
                        if (stats.blocked === TIME_SLOTS.length) {
                            statusBadge.className = 'day-status status-blocked';
                            statusBadge.textContent = 'Blocked';
                        } else if (stats.available > 0) {
                            statusBadge.className = 'day-status status-available';
                            statusBadge.textContent = `${stats.available} slots`;
                        }
                        
                        dayElement.appendChild(statusBadge);
                    }
                });
            } catch (error) {
                console.error('Error loading calendar availability:', error);
            }
        }

        async function selectDateForAvailability(date) {
            selectedDate = date;

            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });

            const dateString = formatDateToYMD(date);
            const dayElement = document.querySelector(`[data-date="${dateString}"]`);
            if (dayElement) {
                dayElement.classList.add('selected');
            }

            const dateDisplay = date.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('selectedDateDisplay').textContent = dateDisplay;

            await loadTimeSlotsForDate(date);
        }

        async function loadTimeSlotsForDate(date) {
            const dateString = formatDateToYMD(date);
            const container = document.getElementById('timeSlotsGrid');
            
            container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Loading...</p></div>';

            try {
                const { data: availability, error } = await supabase
                    .from('availability')
                    .select('*')
                    .eq('date', dateString);

                if (error) throw error;

                const existingSlots = {};
                availability?.forEach(slot => {
                    existingSlots[slot.time_slot] = slot;
                });

                currentTimeSlots = TIME_SLOTS.map(timeSlot => {
                    const existing = existingSlots[timeSlot];
                    return {
                        time_slot: timeSlot,
                        is_available: existing ? existing.is_available : true,
                        id: existing?.id || null
                    };
                });

                renderTimeSlots();
            } catch (error) {
                console.error('Error loading time slots:', error);
                container.innerHTML = '<p style="text-align: center; color: var(--red); padding: 2rem;">Error loading time slots</p>';
            }
        }

        function renderTimeSlots() {
            const container = document.getElementById('timeSlotsGrid');
            container.innerHTML = '';

            currentTimeSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = `time-slot-item ${slot.is_available ? 'available' : 'blocked'}`;
                slotElement.dataset.timeSlot = slot.time_slot;

                slotElement.innerHTML = `
                    <div class="time-slot-time">${slot.time_slot}</div>
                    <div class="time-slot-status ${slot.is_available ? 'status-available' : 'status-blocked'}">
                        ${slot.is_available ? 'Available' : 'Blocked'}
                    </div>
                `;

                slotElement.addEventListener('click', () => toggleTimeSlot(slot.time_slot));
                container.appendChild(slotElement);
            });
        }

        function toggleTimeSlot(timeSlot) {
            const slot = currentTimeSlots.find(s => s.time_slot === timeSlot);
            if (slot) {
                slot.is_available = !slot.is_available;
                renderTimeSlots();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateLastUpdatedTime();
            loadStats();
            loadBookings();
            renderCalendar();
            
            // Update time every minute
            setInterval(updateLastUpdatedTime, 60000);

            // Month Navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            // Time Slot Actions
            document.getElementById('saveAvailability').addEventListener('click', async () => {
                if (!selectedDate) {
                    alert('Please select a date first');
                    return;
                }

                const dateString = formatDateToYMD(selectedDate);
                
                try {
                    // Delete existing slots for this date
                    await supabase
                        .from('availability')
                        .delete()
                        .eq('date', dateString);

                    // Insert new slots
                    const slotsToInsert = currentTimeSlots.map(slot => ({
                        date: dateString,
                        time_slot: slot.time_slot,
                        is_available: slot.is_available
                    }));

                    const { error } = await supabase
                        .from('availability')
                        .insert(slotsToInsert);

                    if (error) throw error;

                    alert('✅ Availability saved successfully!');
                    renderCalendar();
                } catch (error) {
                    console.error('Error saving availability:', error);
                    alert('❌ Error saving availability. Please try again.');
                }
            });

            document.getElementById('markAllAvailable').addEventListener('click', () => {
                if (!selectedDate) {
                    alert('Please select a date first');
                    return;
                }
                currentTimeSlots.forEach(slot => slot.is_available = true);
                renderTimeSlots();
            });

            document.getElementById('blockAllSlots').addEventListener('click', () => {
                if (!selectedDate) {
                    alert('Please select a date first');
                    return;
                }
                if (confirm('Block all time slots for this date?')) {
                    currentTimeSlots.forEach(slot => slot.is_available = false);
                    renderTimeSlots();
                }
            });
        });
    </script>
</body>
</html>
